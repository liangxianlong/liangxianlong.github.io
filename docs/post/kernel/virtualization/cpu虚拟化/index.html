<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='å†…æ ¸ç‰ˆæœ¬linux-5.10.194 kvmtool: http://git.kernel.org/pub/scm/linux/kernel/git/will/kvmtool.git å¯¹äºè™šæ‹ŸåŒ–çš„å­¦ä¹ ï¼Œæœ¬ç³»åˆ—ä»¥linux-5.10.194ä»¥åŠkvmtoolä¸ºå·¥å…·ã€‚ KVMåˆå§‹åŒ– åˆå§‹åŒ–K'>
<title>cpuè™šæ‹ŸåŒ–</title>

<link rel='canonical' href='https://liangxianlong.github.io/post/kernel/virtualization/cpu%E8%99%9A%E6%8B%9F%E5%8C%96/'>

<link rel="stylesheet" href="/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css"><meta property='og:title' content='cpuè™šæ‹ŸåŒ–'>
<meta property='og:description' content='å†…æ ¸ç‰ˆæœ¬linux-5.10.194 kvmtool: http://git.kernel.org/pub/scm/linux/kernel/git/will/kvmtool.git å¯¹äºè™šæ‹ŸåŒ–çš„å­¦ä¹ ï¼Œæœ¬ç³»åˆ—ä»¥linux-5.10.194ä»¥åŠkvmtoolä¸ºå·¥å…·ã€‚ KVMåˆå§‹åŒ– åˆå§‹åŒ–K'>
<meta property='og:url' content='https://liangxianlong.github.io/post/kernel/virtualization/cpu%E8%99%9A%E6%8B%9F%E5%8C%96/'>
<meta property='og:site_name' content='Caesarçš„åšå®¢'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='kernel' /><meta property='article:published_time' content='2023-09-17T14:45:20&#43;08:00'/><meta property='article:modified_time' content='2023-09-17T14:45:20&#43;08:00'/>
<meta name="twitter:title" content="cpuè™šæ‹ŸåŒ–">
<meta name="twitter:description" content="å†…æ ¸ç‰ˆæœ¬linux-5.10.194 kvmtool: http://git.kernel.org/pub/scm/linux/kernel/git/will/kvmtool.git å¯¹äºè™šæ‹ŸåŒ–çš„å­¦ä¹ ï¼Œæœ¬ç³»åˆ—ä»¥linux-5.10.194ä»¥åŠkvmtoolä¸ºå·¥å…·ã€‚ KVMåˆå§‹åŒ– åˆå§‹åŒ–K">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P8CN7B3LZF"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-P8CN7B3LZF', { 'anonymize_ip': false });
}
</script>

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/Q_hu873ddf94e99017dc3ebc855538a443b3_182701_300x0_resize_box_1.gif" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Caesarçš„åšå®¢</a></h1>
            <h2 class="site-description">æ‚Ÿå·²å¾€ä¹‹ä¸è°ï¼ŒçŸ¥ä¾†è€…ä¹‹å¯è¿½.</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://space.bilibili.com/431769236'
                        target="_blank"
                        title="Bç«™"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1694768709765" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4270" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M450.803484 456.506027l-120.670435 23.103715 10.333298 45.288107 119.454151-23.102578-9.117014-45.289244z m65.04448 120.060586c-29.483236 63.220622-55.926329 15.502222-55.926328 15.502223l-19.754098 12.768142s38.90176 53.192249 75.986489 12.764729c43.770311 40.42752 77.203911-13.068516 77.203911-13.068516l-17.934791-11.55072c0.001138-0.304924-31.305956 44.983182-59.575183-16.415858z m59.57632-74.773617L695.182222 524.895573l10.029511-45.288106-120.364373-23.103716-9.423076 45.289245z m237.784178-88.926436c-1.905778-84.362809-75.487004-100.540871-75.487004-100.540871s-57.408853-0.316302-131.944676-0.95232l54.237867-52.332089s8.562916-10.784996-6.026809-22.834062c-14.592-12.051342-15.543182-6.660551-20.615396-3.487289-4.441884 3.169849-69.462471 66.920676-80.878933 78.340551-29.494613 0-60.2624-0.319716-90.075591-0.319716h10.466418s-77.705671-76.754489-82.781298-80.241777c-5.075627-3.488427-5.709369-8.56064-20.616533 3.487289-14.589724 12.05248-6.026809 22.8352-6.026809 22.8352l55.504213 53.919288c-60.261262 0-112.280462 0.319716-136.383147 1.268623-78.025387 22.521173-71.99744 100.859449-71.99744 100.859449s0.950044 168.100978 0 253.103217c8.562916 85.00224 73.899804 98.636231 73.899805 98.636231s26.007324 0.63488 45.357511 0.63488c1.900089 5.391929 3.486151 32.034133 33.302756 32.034134 29.495751 0 33.30048-32.034133 33.30048-32.034134s217.263218-0.950044 235.340231-0.950044c0.953458 9.196658 5.394204 33.619058 35.207395 33.303893 29.494613-0.636018 31.714418-35.20512 31.714418-35.20512s10.151253-0.95232 40.280747 0c70.413653-13.005938 74.534684-95.468658 74.534684-95.468657s-1.265209-169.689316-0.312889-254.056676zM752.628622 681.8304c0 13.319964-10.467556 24.102684-23.471218 24.102684H300.980907c-13.003662 0-23.47008-10.78272-23.47008-24.102684V397.961671c0-13.32224 10.467556-24.106098 23.47008-24.106098h428.176497c13.003662 0 23.471218 10.783858 23.471218 24.106098v283.868729z" fill="#333333" p-id="4271"></path></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/liangxianlong'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='mailto:xianlong_liang@163.com'
                        target="_blank"
                        title="é‚®ç®±"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1694769054956" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5522" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M831.36 335.104L507.84 517.76l-315.52-178.176C195.328 292.928 234.944 256 283.456 256h457.088c46.976 0 85.696 34.56 90.88 79.104zM832 400.512v278.08c0 49.408-40.96 89.408-91.456 89.408H283.456C232.896 768 192 728 192 678.592v-273.28L493.376 575.36c10.368 5.824 22.848 4.736 31.808-1.728 0.448-0.128 0.768-0.384 1.216-0.64L832 400.512z" fill="#BFBFBF" p-id="5523"></path></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>æœç´¢</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>é“¾æ¥</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>æš—è‰²æ¨¡å¼</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#kvmåˆå§‹åŒ–"><code>KVM</code>åˆå§‹åŒ–</a></li>
    <li><a href="#è™šæ‹Ÿæœºçš„åˆ›å»º">è™šæ‹Ÿæœºçš„åˆ›å»º</a>
      <ol>
        <li><a href="#kvmtool"><code>kvmtool</code></a></li>
        <li><a href="#kvm"><code>kvm</code></a>
          <ol>
            <li><a href="#kvm_create_vm"><code>kvm_create_vm</code></a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#vcpuçš„åˆ›å»º"><code>vCPU</code>çš„åˆ›å»º</a>
      <ol>
        <li><a href="#kvm-1"><code>kvm</code></a>
          <ol>
            <li><a href="#kvm_arch_vcpu_create"><code>kvm_arch_vcpu_create</code></a></li>
            <li><a href="#kvm_get_kvm"><code>kvm_get_kvm</code></a></li>
            <li><a href="#create_vcpu_fd"><code>create_vcpu_fd</code></a></li>
            <li><a href="#kvm_arch_vcpu_postcreate"><code>kvm_arch_vcpu_postcreate</code></a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#kvmtoolä¸kvmä¹‹é—´çš„å…±äº«æ•°æ®"><code>kvmtool</code>ä¸<code>kvm</code>ä¹‹é—´çš„å…±äº«æ•°æ®</a>
      <ol>
        <li><a href="#kvm-2"><code>kvm</code></a></li>
      </ol>
    </li>
    <li><a href="#vcpuçš„è¿è¡Œ"><code>vCPU</code>çš„è¿è¡Œ</a></li>
    <li><a href="#vcpuçš„è°ƒåº¦"><code>vCPU</code>çš„è°ƒåº¦</a>
      <ol>
        <li><a href="#vcpu_load"><code>vcpu_load</code></a>
          <ol>
            <li><a href="#kvm_arch_vcpu_load"><code>kvm_arch_vcpu_load</code></a></li>
          </ol>
        </li>
        <li><a href="#vcpu_put"><code>vcpu_put</code></a></li>
        <li><a href="#kvm_sched_in"><code>kvm_sched_in</code></a></li>
        <li><a href="#kvm_sched_out"><code>kvm_sched_out</code></a></li>
      </ol>
    </li>
    <li><a href="#simple-kvmtool"><code>simple-kvmtool</code></a></li>
    <li><a href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/kernel-virtuallization/" >
                kernel-virtuallization
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/kernel/virtualization/cpu%E8%99%9A%E6%8B%9F%E5%8C%96/">cpuè™šæ‹ŸåŒ–</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Sep 17, 2023</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 31 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>å†…æ ¸ç‰ˆæœ¬<code>linux-5.10.194</code></p>
<p><code>kvmtool</code>: <a class="link" href="http://git.kernel.org/pub/scm/linux/kernel/git/will/kvmtool.git"  target="_blank" rel="noopener"
    >http://git.kernel.org/pub/scm/linux/kernel/git/will/kvmtool.git</a></p>
<p>å¯¹äºè™šæ‹ŸåŒ–çš„å­¦ä¹ ï¼Œæœ¬ç³»åˆ—ä»¥<code>linux-5.10.194</code>ä»¥åŠ<code>kvmtool</code>ä¸ºå·¥å…·ã€‚</p>
<h2 id="kvmåˆå§‹åŒ–"><code>KVM</code>åˆå§‹åŒ–</h2>
<p>åˆå§‹åŒ–<code>KVM</code>æ—¶ï¼Œéœ€è¦åŠ è½½<code>kvm.ko</code>ä»¥åŠ<code>kvm-intel.ko</code>ä¸¤ä¸ªå†…æ ¸æ¨¡å—ã€‚å…¶ä¸­<code>kvm.ko</code>ç”±<code>KVM</code>çš„é€šç”¨ä»£ç ç”Ÿæˆï¼Œ<code>kvm-intel.ko</code>æ˜¯ç”±<code>Intel CPU</code>æ¶æ„ç›¸å…³ä»£ç ç”Ÿæˆã€‚æœ€ç»ˆ<code>kvmtool</code>å’Œ<code>kvm</code>çš„äº¤äº’ç”±<code>kvm.ko</code>å¯¼å‡ºçš„è®¾å¤‡<code>/dev/kvm</code>å®Œæˆã€‚</p>
<p>æ•´ä¸ª<code>KVM</code>çš„åˆå§‹åŒ–ç”±å‡½æ•°<code>vmx_init</code>æ¥å®Œæˆï¼Œå…¶ä¸»è¦è°ƒç”¨äº†<code>kvm_init</code>å‡½æ•°ã€‚</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">int</span> __init <span style="color:#008b45">vmx_init</span>(<span style="color:#00688b;font-weight:bold">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#00688b;font-weight:bold">int</span> r, cpu;
</span></span><span style="display:flex;"><span>    r = <span style="color:#008b45">kvm_init</span>(&amp;vmx_init_ops, <span style="color:#8b008b;font-weight:bold">sizeof</span>(<span style="color:#8b008b;font-weight:bold">struct</span> vcpu_vmx),
</span></span><span style="display:flex;"><span>             <span style="color:#008b45">__alignof__</span>(<span style="color:#8b008b;font-weight:bold">struct</span> vcpu_vmx), THIS_MODULE);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‡½æ•°<code>kvm_init</code>ä¸­çš„<code>vmx_init_ops</code>å‚æ•°è¡¨ç¤º<code>Intel VT-x</code>å®ç°çš„å„ç§å›è°ƒå‡½æ•°:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">struct</span> kvm_x86_init_ops vmx_init_ops __initdata = {
</span></span><span style="display:flex;"><span>    .cpu_has_kvm_support = cpu_has_kvm_support,
</span></span><span style="display:flex;"><span>    .disabled_by_bios = vmx_disabled_by_bios,
</span></span><span style="display:flex;"><span>    .check_processor_compatibility = vmx_check_processor_compat,
</span></span><span style="display:flex;"><span>    .hardware_setup = hardware_setup,
</span></span><span style="display:flex;"><span>    .handle_intel_pt_intr = <span style="color:#658b00">NULL</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .runtime_ops = &amp;vmx_x86_ops,
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>vmx_init_ops</code>ä¸­å†…åµŒå˜é‡<code>runtime_ops</code>ç”±<code>vmx_x86_ops</code>æŒ‡å®šã€‚å¯ä»¥çœ‹åˆ°<code>vmx_x86_ops</code>æ‰æ˜¯çœŸæ­£çš„<code>Intel VT-x</code>å›è°ƒå‡½æ•°é›†åˆï¼š</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">struct</span> kvm_x86_ops vmx_x86_ops __initdata = {
</span></span><span style="display:flex;"><span>    .name = <span style="color:#cd5555">&#34;kvm_intel&#34;</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .hardware_unsetup = hardware_unsetup,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .hardware_enable = hardware_enable,
</span></span><span style="display:flex;"><span>    .hardware_disable = hardware_disable,
</span></span><span style="display:flex;"><span>    .cpu_has_accelerated_tpr = report_flexpriority,
</span></span><span style="display:flex;"><span>    .has_emulated_msr = vmx_has_emulated_msr,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .vm_size = <span style="color:#8b008b;font-weight:bold">sizeof</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vmx),
</span></span><span style="display:flex;"><span>    .vm_init = vmx_vm_init,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .vcpu_create = vmx_create_vcpu,
</span></span><span style="display:flex;"><span>    .vcpu_free = vmx_free_vcpu,
</span></span><span style="display:flex;"><span>    .vcpu_reset = vmx_vcpu_reset,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .prepare_guest_switch = vmx_prepare_switch_to_guest,
</span></span><span style="display:flex;"><span>    .vcpu_load = vmx_vcpu_load,
</span></span><span style="display:flex;"><span>    .vcpu_put = vmx_vcpu_put,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .update_exception_bitmap = vmx_update_exception_bitmap,
</span></span><span style="display:flex;"><span>    .get_msr_feature = vmx_get_msr_feature,
</span></span><span style="display:flex;"><span>    .get_msr = vmx_get_msr,
</span></span><span style="display:flex;"><span>    .set_msr = vmx_set_msr,
</span></span><span style="display:flex;"><span>    .get_segment_base = vmx_get_segment_base,
</span></span><span style="display:flex;"><span>    .get_segment = vmx_get_segment,
</span></span><span style="display:flex;"><span>    .set_segment = vmx_set_segment,
</span></span><span style="display:flex;"><span>    .get_cpl = vmx_get_cpl,
</span></span><span style="display:flex;"><span>    .get_cs_db_l_bits = vmx_get_cs_db_l_bits,
</span></span><span style="display:flex;"><span>    .set_cr0 = vmx_set_cr0,
</span></span><span style="display:flex;"><span>    .is_valid_cr4 = vmx_is_valid_cr4,
</span></span><span style="display:flex;"><span>    .set_cr4 = vmx_set_cr4,
</span></span><span style="display:flex;"><span>    .set_efer = vmx_set_efer,
</span></span><span style="display:flex;"><span>    .get_idt = vmx_get_idt,
</span></span><span style="display:flex;"><span>    .set_idt = vmx_set_idt,
</span></span><span style="display:flex;"><span>    .get_gdt = vmx_get_gdt,
</span></span><span style="display:flex;"><span>    .set_gdt = vmx_set_gdt,
</span></span><span style="display:flex;"><span>    .set_dr7 = vmx_set_dr7,
</span></span><span style="display:flex;"><span>    .sync_dirty_debug_regs = vmx_sync_dirty_debug_regs,
</span></span><span style="display:flex;"><span>    .cache_reg = vmx_cache_reg,
</span></span><span style="display:flex;"><span>    .get_rflags = vmx_get_rflags,
</span></span><span style="display:flex;"><span>    .set_rflags = vmx_set_rflags,
</span></span><span style="display:flex;"><span>    .get_if_flag = vmx_get_if_flag,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .tlb_flush_all = vmx_flush_tlb_all,
</span></span><span style="display:flex;"><span>    .tlb_flush_current = vmx_flush_tlb_current,
</span></span><span style="display:flex;"><span>    .tlb_flush_gva = vmx_flush_tlb_gva,
</span></span><span style="display:flex;"><span>    .tlb_flush_guest = vmx_flush_tlb_guest,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .vcpu_pre_run = vmx_vcpu_pre_run,
</span></span><span style="display:flex;"><span>    .run = vmx_vcpu_run,
</span></span><span style="display:flex;"><span>    .handle_exit = vmx_handle_exit,
</span></span><span style="display:flex;"><span>    .skip_emulated_instruction = vmx_skip_emulated_instruction,
</span></span><span style="display:flex;"><span>    .update_emulated_instruction = vmx_update_emulated_instruction,
</span></span><span style="display:flex;"><span>    .set_interrupt_shadow = vmx_set_interrupt_shadow,
</span></span><span style="display:flex;"><span>    .get_interrupt_shadow = vmx_get_interrupt_shadow,
</span></span><span style="display:flex;"><span>    .patch_hypercall = vmx_patch_hypercall,
</span></span><span style="display:flex;"><span>    .set_irq = vmx_inject_irq,
</span></span><span style="display:flex;"><span>    .set_nmi = vmx_inject_nmi,
</span></span><span style="display:flex;"><span>    .queue_exception = vmx_queue_exception,
</span></span><span style="display:flex;"><span>    .cancel_injection = vmx_cancel_injection,
</span></span><span style="display:flex;"><span>    .interrupt_allowed = vmx_interrupt_allowed,
</span></span><span style="display:flex;"><span>    .nmi_allowed = vmx_nmi_allowed,
</span></span><span style="display:flex;"><span>    .get_nmi_mask = vmx_get_nmi_mask,
</span></span><span style="display:flex;"><span>    .set_nmi_mask = vmx_set_nmi_mask,
</span></span><span style="display:flex;"><span>    .enable_nmi_window = vmx_enable_nmi_window,
</span></span><span style="display:flex;"><span>    .enable_irq_window = vmx_enable_irq_window,
</span></span><span style="display:flex;"><span>    .update_cr8_intercept = vmx_update_cr8_intercept,
</span></span><span style="display:flex;"><span>    .set_virtual_apic_mode = vmx_set_virtual_apic_mode,
</span></span><span style="display:flex;"><span>    .set_apic_access_page_addr = vmx_set_apic_access_page_addr,
</span></span><span style="display:flex;"><span>    .refresh_apicv_exec_ctrl = vmx_refresh_apicv_exec_ctrl,
</span></span><span style="display:flex;"><span>    .load_eoi_exitmap = vmx_load_eoi_exitmap,
</span></span><span style="display:flex;"><span>    .apicv_post_state_restore = vmx_apicv_post_state_restore,
</span></span><span style="display:flex;"><span>    .check_apicv_inhibit_reasons = vmx_check_apicv_inhibit_reasons,
</span></span><span style="display:flex;"><span>    .hwapic_irr_update = vmx_hwapic_irr_update,
</span></span><span style="display:flex;"><span>    .hwapic_isr_update = vmx_hwapic_isr_update,
</span></span><span style="display:flex;"><span>    .guest_apic_has_interrupt = vmx_guest_apic_has_interrupt,
</span></span><span style="display:flex;"><span>    .sync_pir_to_irr = vmx_sync_pir_to_irr,
</span></span><span style="display:flex;"><span>    .deliver_interrupt = vmx_deliver_interrupt,
</span></span><span style="display:flex;"><span>    .dy_apicv_has_pending_interrupt = pi_has_pending_interrupt,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .set_tss_addr = vmx_set_tss_addr,
</span></span><span style="display:flex;"><span>    .set_identity_map_addr = vmx_set_identity_map_addr,
</span></span><span style="display:flex;"><span>    .get_mt_mask = vmx_get_mt_mask,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .get_exit_info = vmx_get_exit_info,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .vcpu_after_set_cpuid = vmx_vcpu_after_set_cpuid,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .has_wbinvd_exit = cpu_has_vmx_wbinvd_exit,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .get_l2_tsc_offset = vmx_get_l2_tsc_offset,
</span></span><span style="display:flex;"><span>    .get_l2_tsc_multiplier = vmx_get_l2_tsc_multiplier,
</span></span><span style="display:flex;"><span>    .write_tsc_offset = vmx_write_tsc_offset,
</span></span><span style="display:flex;"><span>    .write_tsc_multiplier = vmx_write_tsc_multiplier,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .load_mmu_pgd = vmx_load_mmu_pgd,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .check_intercept = vmx_check_intercept,
</span></span><span style="display:flex;"><span>    .handle_exit_irqoff = vmx_handle_exit_irqoff,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .request_immediate_exit = vmx_request_immediate_exit,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .sched_in = vmx_sched_in,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .cpu_dirty_log_size = PML_ENTITY_NUM,
</span></span><span style="display:flex;"><span>    .update_cpu_dirty_logging = vmx_update_cpu_dirty_logging,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .pmu_ops = &amp;intel_pmu_ops,
</span></span><span style="display:flex;"><span>    .nested_ops = &amp;vmx_nested_ops,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .update_pi_irte = pi_update_irte,
</span></span><span style="display:flex;"><span>    .start_assignment = vmx_pi_start_assignment,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#1e889b">#ifdef CONFIG_X86_64
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>    .set_hv_timer = vmx_set_hv_timer,
</span></span><span style="display:flex;"><span>    .cancel_hv_timer = vmx_cancel_hv_timer,
</span></span><span style="display:flex;"><span><span style="color:#1e889b">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>
</span></span><span style="display:flex;"><span>    .setup_mce = vmx_setup_mce,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .smi_allowed = vmx_smi_allowed,
</span></span><span style="display:flex;"><span>    .enter_smm = vmx_enter_smm,
</span></span><span style="display:flex;"><span>    .leave_smm = vmx_leave_smm,
</span></span><span style="display:flex;"><span>    .enable_smi_window = vmx_enable_smi_window,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .can_emulate_instruction = vmx_can_emulate_instruction,
</span></span><span style="display:flex;"><span>    .apic_init_signal_blocked = vmx_apic_init_signal_blocked,
</span></span><span style="display:flex;"><span>    .migrate_timers = vmx_migrate_timers,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .msr_filter_changed = vmx_msr_filter_changed,
</span></span><span style="display:flex;"><span>    .complete_emulated_msr = kvm_complete_insn_gp,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .vcpu_deliver_sipi_vector = kvm_vcpu_deliver_sipi_vector,
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚ä¸‹å›¾æ‰€ç¤ºä»¥<code>kvm_init</code>ä¸ºä¸­å¿ƒçš„å‡½æ•°è°ƒç”¨å›¾ï¼š</p>
<img title="" src="kvm_init.png" alt="loading-ag-889" data-align="center">
<p>å‡½æ•°è¯´æ˜</p>
<ul>
<li>
<p><code>kvm_arch_init</code>:</p>
<ul>
<li>
<p><code>cpu_has_kvm_support</code>å’Œ<code>disabled_by_bios</code>:æ£€æµ‹é€»è¾‘<code>cpu</code>æ˜¯å¦æ”¯æŒ<code>VMX</code>æ“ä½œï¼Œä»¥åŠæ˜¯å¦è¢«<code>Bios</code>å…³é—­ã€‚</p>
</li>
<li>
<p><code>kvm_mmu_vendor_module_init</code>:å†…å­˜è™šæ‹ŸåŒ–åˆå§‹åŒ–ã€‚</p>
</li>
<li>
<p><code>kvm_timer_init</code>:æ—¶é—´è™šæ‹ŸåŒ–åˆå§‹åŒ–ã€‚</p>
</li>
</ul>
</li>
<li>
<p><code>kvm_arch_hardware_setup</code>:</p>
<ul>
<li><code>set_vmcs_config</code>æ ¹æ®å½“å‰é€»è¾‘<code>cpu</code>åˆ›å»ºä¸€ä¸ªå…¨å±€çš„<code>vmcs_config</code>ç”¨äºä¸åç»­çš„æ¯ä¸€ä¸ªé€»è¾‘<code>cpu</code>çš„<code>vmcs_conf</code>åšæ¯”è¾ƒï¼Œè‹¥ä¸ä¸€è‡´åˆ™é€€å‡º<code>KVM</code>åˆå§‹åŒ–æµç¨‹ã€‚</li>
<li><code>cpu_has_vmx_ept</code>å’Œ<code>cpu_has_vmx_apicv</code>:æ ¹æ®<code>vmcs_config</code>å’Œ<code>MSR</code>å€¼æ¥è®¾ç½®æŸäº›å…¨å±€å˜é‡ï¼Œæ¯”å¦‚æ˜¯å¦æ”¯æŒ<code>EPT</code>çš„<code>enable_ept</code>å˜é‡()ã€‚</li>
<li><code>kvm_configure_mmu</code>:æ ¹æ®å…¨å±€å˜é‡<code>enable_ept</code>è®¾ç½®å…¨å±€å˜é‡<code>tdp_enabled</code>ä»¥åŠ<code>max_huge_page_level</code>ã€‚</li>
<li><code>alloc_kvm_area()</code>:åˆ†é…<code>vmxon</code>åŒºåŸŸï¼Œå¹¶ä¸”æ”¾åˆ°<code>vmxarea</code>è¿™ä¸ª<code>percpu</code>å˜é‡ä¸­ã€‚</li>
</ul>
</li>
<li>
<p><code>check_processor_compat</code>:æ£€æµ‹æ‰€æœ‰çš„é€»è¾‘<code>cpu</code>çš„<code>vmcs</code>æ˜¯å¦ä¸€è‡´ã€‚</p>
</li>
<li>
<p><code>misc_register</code>:æ³¨å†Œ<code>misc</code>è®¾å¤‡<code>/deev/kvm</code>ã€‚</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>r = <span style="color:#008b45">misc_register</span>(&amp;kvm_dev);
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">struct</span> miscdevice kvm_dev = {
</span></span><span style="display:flex;"><span>    KVM_MINOR,
</span></span><span style="display:flex;"><span>    <span style="color:#cd5555">&#34;kvm&#34;</span>,
</span></span><span style="display:flex;"><span>    &amp;kvm_chardev_ops,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">struct</span> file_operations kvm_chardev_ops = {
</span></span><span style="display:flex;"><span>    .unlocked_ioctl = kvm_dev_ioctl,
</span></span><span style="display:flex;"><span>    .llseek        = noop_llseek,
</span></span><span style="display:flex;"><span>    <span style="color:#008b45">KVM_COMPAT</span>(kvm_dev_ioctl),
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>é€šè¿‡<code>misc_register(&amp;kvm_dev)</code>å°±æ³¨å†Œäº†<code>misc</code>è®¾å¤‡<code>/dev/kvm</code>ï¼Œå¯ä»¥çœ‹åˆ°<code>/dev/kvm</code>åªæ”¯æŒ<code>ioctl</code>ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<p><code>kvm_dev_ioctl</code>ä»£ç å¦‚ä¸‹</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">long</span> <span style="color:#008b45">kvm_dev_ioctl</span>(<span style="color:#8b008b;font-weight:bold">struct</span> file *filp,
</span></span><span style="display:flex;"><span>              <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> ioctl, <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">long</span> arg)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#00688b;font-weight:bold">long</span> r = -EINVAL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">switch</span> (ioctl) {
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">case</span> KVM_GET_API_VERSION:
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">if</span> (arg)
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">goto</span> out;
</span></span><span style="display:flex;"><span>        r = KVM_API_VERSION;
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">case</span> KVM_CREATE_VM:
</span></span><span style="display:flex;"><span>        r = <span style="color:#008b45">kvm_dev_ioctl_create_vm</span>(arg);
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">case</span> KVM_CHECK_EXTENSION:
</span></span><span style="display:flex;"><span>        r = <span style="color:#008b45">kvm_vm_ioctl_check_extension_generic</span>(<span style="color:#658b00">NULL</span>, arg);
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">case</span> KVM_GET_VCPU_MMAP_SIZE:
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">if</span> (arg)
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">goto</span> out;
</span></span><span style="display:flex;"><span>        r = PAGE_SIZE;     <span style="color:#228b22">/* struct kvm_run */</span>
</span></span><span style="display:flex;"><span><span style="color:#1e889b">#ifdef CONFIG_X86
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>        r += PAGE_SIZE;    <span style="color:#228b22">/* pio data page */</span>
</span></span><span style="display:flex;"><span><span style="color:#1e889b">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#ifdef CONFIG_KVM_MMIO
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>        r += PAGE_SIZE;    <span style="color:#228b22">/* coalesced mmio ring page */</span>
</span></span><span style="display:flex;"><span><span style="color:#1e889b">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>        <span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">case</span> KVM_TRACE_ENABLE:
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">case</span> KVM_TRACE_PAUSE:
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">case</span> KVM_TRACE_DISABLE:
</span></span><span style="display:flex;"><span>        r = -EOPNOTSUPP;
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">default</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#008b45">kvm_arch_dev_ioctl</span>(filp, ioctl, arg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>out:
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> r;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»ä¸Šè¿°ä»£ç å¯ä»¥çœ‹åˆ°<code>/dev/kvm</code>çš„<code>ioctl</code>æ¥å£åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ul>
<li>
<p>é€šç”¨æ¥å£:æ¯”å¦‚<code>KVM_API_VERSION</code>å’Œ<code>KVM_CREATE_VM</code>ã€‚</p>
</li>
<li>
<p>æ¶æ„ç›¸å…³æ¥å£:<code>kvm_arch_dev_ioctl</code>ã€‚</p>
</li>
</ul>
<p>æ­¤å¤–ï¼Œå‚è§å¦‚ä¸‹å›¾ï¼Œæ•´ä¸ª<code>KVM</code>è¿˜åŒ…æ‹¬<code>VM</code>å±‚é¢çš„<code>ioctl</code>ä»¥åŠ<code>VCPU</code>å±‚é¢çš„<code>ioctl</code>ã€‚</p>
<img title="" src="kvm_ioctl.png" alt="kvm_ioctl.png" data-align="center">
<p><code>KVM</code>çš„åˆå§‹åŒ–æµç¨‹æ²¡æœ‰ä½¿é€»è¾‘<code>cpu</code>è¿›å…¥<code>VMX</code>æ¨¡å¼ï¼Œå› ä¸ºåœ¨æ•´ä¸ª<code>vmx_init</code>æµç¨‹ä¸­å¹¶æ²¡æœ‰å°†<code>CR4.VMXE[bit 13]</code>è®¾ç½®ä¸º<code>1</code>ã€‚<code>VMX</code>æ¨¡å¼çš„å¼€å¯æ˜¯åœ¨åˆ›å»ºç¬¬ä¸€ä¸ªè™šæ‹Ÿæœºçš„æ—¶å€™ã€‚</p>
<h2 id="è™šæ‹Ÿæœºçš„åˆ›å»º">è™šæ‹Ÿæœºçš„åˆ›å»º</h2>
<p>åˆ›å»º<code>KVM</code>è™šæ‹Ÿæœºéœ€è¦ç”¨æˆ·æ€çš„<code>kvmtool</code>å‘èµ·ã€‚åœ¨<code>kvmtool</code>ä»£ç ä¸­ï¼Œåˆ›å»º<code>KVM</code>è™šæ‹Ÿæœºçš„æµç¨‹ç”±<code>kvm__init</code>å‘èµ·ã€‚<code>kvmtool</code>å’Œ<code>kvm</code>çš„äº¤äº’å¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<img title="" src="kvm_vm_create.png" alt="kvm_vm_create.png" data-align="center">
<h3 id="kvmtool"><code>kvmtool</code></h3>
<ul>
<li>
<p>æ‰“å¼€<code>/dev/kvm</code>è®¾å¤‡æ–‡ä»¶ï¼Œè·å–æ­¤è®¾å¤‡æ–‡ä»¶çš„<code>fd</code>ã€‚</p>
</li>
<li>
<p>æ ¹æ®<code>1.</code>ä¸­çš„<code>fd</code>ï¼Œå‘èµ·<code>KVM_CREATE_VM</code>è°ƒç”¨ï¼Œè¯·æ±‚<code>kvm</code>åˆ›å»ºè™šæ‹Ÿæœºã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
</li>
</ul>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">int</span> <span style="color:#008b45">kvm__init</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm *kvm)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#00688b;font-weight:bold">int</span> ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// kvm__arch_cpu_supports_vm: ä½¿ç”¨cpuidæŒ‡ä»¤æ£€æµ‹ç¡¬ä»¶ç¯å¢ƒæ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">if</span> (!<span style="color:#008b45">kvm__arch_cpu_supports_vm</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#008b45">pr_err</span>(<span style="color:#cd5555">&#34;Your CPU does not support hardware virtualization&#34;</span>);
</span></span><span style="display:flex;"><span>        ret = -ENOSYS;
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">goto</span> err;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// open /dev/kvm
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    kvm-&gt;sys_fd = <span style="color:#008b45">open</span>(kvm-&gt;cfg.dev, O_RDWR);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// KVM_GET_API_VERSION: Get the API version as the stable kvm API
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    ret = <span style="color:#008b45">ioctl</span>(kvm-&gt;sys_fd, KVM_GET_API_VERSION, <span style="color:#b452cd">0</span>);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// KVM_CREATE_VM: åˆ›å»ºè™šæ‹Ÿæœº
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    kvm-&gt;vm_fd = <span style="color:#008b45">ioctl</span>(kvm-&gt;sys_fd, KVM_CREATE_VM, <span style="color:#008b45">kvm__get_vm_type</span>(kvm));
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// query about extensions to the core kvm API.
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">if</span> (<span style="color:#008b45">kvm__check_extensions</span>(kvm)) {
</span></span><span style="display:flex;"><span>        <span style="color:#008b45">pr_err</span>(<span style="color:#cd5555">&#34;A required KVM extension is not supported by OS&#34;</span>);
</span></span><span style="display:flex;"><span>        ret = -ENOSYS;
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">goto</span> err_vm_fd;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#008b45">kvm__arch_init</span>(kvm);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="kvm"><code>kvm</code></h3>
<p>åœ¨å†…æ ¸<code>KVM</code>æ¨¡å—ä¸­ï¼Œå‡½æ•°<code>kvm_dev_ioctl</code>æ ¹æ®<code>kvmtool</code>å‘èµ·<code>ioctl</code>è°ƒç”¨æ—¶ä¼ å…¥çš„<code>KVM_CREATE_VM</code>æœ€ç»ˆè°ƒç”¨åˆ°<code>kvm_dev_ioctl_create_vm</code>å‡½æ•°ï¼Œ</p>
<ul>
<li>
<p><code>kvm_create_vm</code>:åˆ›å»ºè™šæ‹Ÿæœºçš„æ ¸å¿ƒå‡½æ•°ã€‚</p>
</li>
<li>
<p><code>kvm_coalesced_mmio_init``:å¯¹``coalesced MMIO</code>è¿›è¡Œåˆå§‹åŒ–ã€‚å…¶å®å°±æ˜¯åˆ†é…äº†ä¸€ä¸ª<code>struct page</code>ï¼Œç„¶åå°†æ­¤<code>page</code>æ‰€åœ¨çš„è™šæ‹Ÿåœ°å€èµ‹å€¼ç»™<code>kvm-&gt;coalesced_mmio_ring</code>ã€‚</p>
</li>
<li>
<p><code>get_unused_fd_flags</code>:è·å–ä¸€ä¸ªæœªè¢«ä½¿ç”¨çš„<code>fd</code>ï¼Œæ­¤<code>fd</code>ä½œä¸º<code>VM</code>å±‚é¢è°ƒç”¨<code>ioctl</code>æ—¶çš„<code>fd</code>ã€‚</p>
</li>
<li>
<p><code>anon_inode_getfile</code>:åˆ›å»ºä¸€ä¸ªåŒ¿åçš„æ–‡ä»¶å®ä¾‹ã€‚</p>
</li>
<li>
<p><code>fd_install</code>:å°†<code>get_unused_fd_flags</code>è·å–çš„<code>fd</code>å’Œ<code>anon_inode_getfile</code>åˆ›å»ºçš„åŒ¿åæ–‡ä»¶å®ä¾‹å…³è”èµ·æ¥ã€‚</p>
</li>
</ul>
<h4 id="kvm_create_vm"><code>kvm_create_vm</code></h4>
<p>ä½œä¸ºåˆ›å»ºè™šæ‹Ÿæœºæ ¸å¿ƒå‡½æ•°ï¼Œ<code>kvm_create_vm</code>è°ƒç”¨å…³ç³»å¦‚ä¸‹:</p>
<img title="" src="kvm_create_vm.png" alt="kvm_create_vm.png" data-align="center">
<p>ç²¾ç®€åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">struct</span> kvm *<span style="color:#008b45">kvm_create_vm</span>(<span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">long</span> type)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">struct</span> kvm *kvm = <span style="color:#008b45">kvm_arch_alloc_vm</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">struct</span> kvm_memslots *slots;
</span></span><span style="display:flex;"><span>    <span style="color:#00688b;font-weight:bold">int</span> r = -ENOMEM;
</span></span><span style="display:flex;"><span>    <span style="color:#00688b;font-weight:bold">int</span> i, j;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#008b45">mmgrab</span>(current-&gt;mm);
</span></span><span style="display:flex;"><span>    kvm-&gt;mm = current-&gt;mm;
</span></span><span style="display:flex;"><span>    <span style="color:#008b45">kvm_eventfd_init</span>(kvm);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#008b45">xa_init</span>(&amp;kvm-&gt;vcpu_array);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#008b45">refcount_set</span>(&amp;kvm-&gt;users_count, <span style="color:#b452cd">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">for</span> (i = <span style="color:#b452cd">0</span>; i &lt; KVM_ADDRESS_SPACE_NUM; i++) {
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">for</span> (j = <span style="color:#b452cd">0</span>; j &lt; <span style="color:#b452cd">2</span>; j++) {
</span></span><span style="display:flex;"><span>            slots = &amp;kvm-&gt;__memslots[i][j];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#008b45">atomic_long_set</span>(&amp;slots-&gt;last_used_slot, (<span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">long</span>)<span style="color:#658b00">NULL</span>);
</span></span><span style="display:flex;"><span>            slots-&gt;hva_tree = RB_ROOT_CACHED;
</span></span><span style="display:flex;"><span>            slots-&gt;gfn_tree = RB_ROOT;
</span></span><span style="display:flex;"><span>            <span style="color:#008b45">hash_init</span>(slots-&gt;id_hash);
</span></span><span style="display:flex;"><span>            slots-&gt;node_idx = j;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">/* Generations must be different for each address space. */</span>
</span></span><span style="display:flex;"><span>            slots-&gt;generation = i;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#008b45">rcu_assign_pointer</span>(kvm-&gt;memslots[i], &amp;kvm-&gt;__memslots[i][<span style="color:#b452cd">0</span>]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">for</span> (i = <span style="color:#b452cd">0</span>; i &lt; KVM_NR_BUSES; i++) {
</span></span><span style="display:flex;"><span>        <span style="color:#008b45">rcu_assign_pointer</span>(kvm-&gt;buses[i],
</span></span><span style="display:flex;"><span>            <span style="color:#008b45">kzalloc</span>(<span style="color:#8b008b;font-weight:bold">sizeof</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm_io_bus), GFP_KERNEL_ACCOUNT));
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">if</span> (!kvm-&gt;buses[i])
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">goto</span> out_err_no_arch_destroy_vm;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    kvm-&gt;max_halt_poll_ns = halt_poll_ns;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    r = <span style="color:#008b45">kvm_arch_init_vm</span>(kvm, type);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    r = <span style="color:#008b45">hardware_enable_all</span>();
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#1e889b">#ifdef CONFIG_HAVE_KVM_IRQFD
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>    <span style="color:#008b45">INIT_HLIST_HEAD</span>(&amp;kvm-&gt;irq_ack_notifier_list);
</span></span><span style="display:flex;"><span><span style="color:#1e889b">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>
</span></span><span style="display:flex;"><span>    r = <span style="color:#008b45">kvm_init_mmu_notifier</span>(kvm);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    r = <span style="color:#008b45">kvm_arch_post_init_vm</span>(kvm);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#008b45">list_add</span>(&amp;kvm-&gt;vm_list, &amp;vm_list);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#008b45">preempt_notifier_inc</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#008b45">kvm_init_pm_notifier</span>(kvm);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * When the fd passed to this ioctl() is opened it pins the module,
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * but try_module_get() also prevents getting a reference if the module
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * is in MODULE_STATE_GOING (e.g. if someone ran &#34;rmmod --wait&#34;).
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">if</span> (!<span style="color:#008b45">try_module_get</span>(kvm_chardev_ops.owner)) {
</span></span><span style="display:flex;"><span>        r = -ENODEV;
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">goto</span> out_err;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> kvm;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>out_err:
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#008b45">ERR_PTR</span>(r);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><code>kvm_arch_alloc_vm</code>:åˆ†é…ä¸€ä¸ª<code>struct kvm</code>æŒ‡é’ˆï¼Œç”¨äºè¡¨ç¤ºä¸€å°è™šæ‹Ÿæœºã€‚</p>
</li>
<li>
<p><code>kvm_arch_init_vm</code>:åˆå§‹åŒ–<code>struct kvm-&gt;arch</code>å˜é‡ã€‚</p>
</li>
<li>
<p><code>hardware_enable_all</code>:è®¾ç½®<code>CR4.VMXE[bit 13] = 1</code>ä½¿èƒ½<code>VMX</code>æ¨¡å¼ï¼›å¯¹æ¯ä¸€ä¸ªé€»è¾‘<code>cpu</code>è°ƒç”¨<code>vmxon</code>æŒ‡ä»¤ä½¿å…¶è¿›å…¥<code>VMX</code>æ¨¡å¼ã€‚</p>
</li>
<li>
<p><code>list_add(&amp;kvm-&gt;vm_list, &amp;vm_list)</code>:å°†<code>kvm-&gt;vm_list</code>æŒ‚åˆ°ä»¥<code>vm_list</code>ä¸ºå¤´èŠ‚ç‚¹çš„é“¾è¡¨ä¸Šã€‚</p>
</li>
</ul>
<h2 id="vcpuçš„åˆ›å»º"><code>vCPU</code>çš„åˆ›å»º</h2>
<p>è™šæ‹Ÿæœºåˆ›å»ºå®Œæˆåï¼Œ<code>kvmtool</code>å¯ä»¥æ ¹æ®å…¶è°ƒç”¨<code>KVM_CREATE_VM</code>æ—¶è¿”å›çš„è™šæ‹Ÿæœº<code>fd</code>å‘èµ·æ–°çš„<code>ioctl</code>è°ƒç”¨ï¼Œè¯·æ±‚åˆ›å»º<code>vCPU</code>ã€‚åœ¨<code>kvmtool</code>ä¸­ï¼Œæ¯ä¸€ä¸ª<code>vCPU</code>å¯¹åº”å®¿ä¸»æœºæ“ä½œç³»ç»Ÿä¸­çš„ä¸€ä¸ªç”¨æˆ·æ€çº¿ç¨‹ã€‚åœ¨åˆ›å»ºå•ä¸ª<code>vCPU</code>æ—¶ï¼Œ<code>kvmtool</code>å’Œ<code>kvm</code>çš„äº¤äº’å¦‚ä¸‹å›¾ã€‚</p>
<img title="vcpu_create" src="vcpu_create.png" alt="vcpu_create.png" data-align="center">
<p>å›¾ä¸­<code>kvmtool</code>ä¾§<code>vcpu-&gt;kvm-&gt;vmfd</code>å°±æ˜¯<a class="link" href="#%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%9a%84%e5%88%9b%e5%bb%ba" >è™šæ‹Ÿæœºçš„åˆ›å»º</a>ä¸­ç”±<code>KVM_CREATE_VM</code>è¿”å›çš„è™šæ‹Ÿæœº<code>fd</code>ã€‚è™šæ‹Ÿæœº<code>fd</code>æ‰€å…³è”çš„åŒ¿åæ–‡ä»¶<code>file_operations</code>åœ¨<code>kvm</code>ä¸­å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">struct</span> file_operations kvm_vm_fops = {
</span></span><span style="display:flex;"><span>    .release        = kvm_vm_release,
</span></span><span style="display:flex;"><span>    .unlocked_ioctl = kvm_vm_ioctl,
</span></span><span style="display:flex;"><span>    .llseek        = noop_llseek,
</span></span><span style="display:flex;"><span>    <span style="color:#008b45">KVM_COMPAT</span>(kvm_vm_compat_ioctl),
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>kvm</code>ä¾§å‡½æ•°ç®€ä»‹:</p>
<ul>
<li>
<p><code>vcpu = kmem_cache_zalloc</code>:åˆ†é…<code>struct kvm_vcpu</code>æŒ‡é’ˆå˜é‡ï¼Œæ­¤å˜é‡æ˜¯ä¸€ä¸ª<code>kvm_vcpu_cache</code>ã€‚</p>
</li>
<li>
<p><code>kvm_vcpu_init(vcpu, kvm, id)</code>:åˆå§‹åŒ–ç”±<code>kmem_cache_zalloc</code>åˆ†é…çš„æŒ‡é’ˆå˜é‡ï¼Œå°†è™šæ‹Ÿæœºæ‰€å±çš„<code>struct kvm</code>å˜é‡å’Œå…¶å…³è”(<code>vcpu-&gt;kvm = kvm</code> )ã€‚</p>
</li>
<li>
<p><strong><code>kvm_arch_vcpu_create(vcpu)</code></strong>:æ­¤å‡½æ•°æ˜¯åˆ›å»º<code>vCPU</code>çš„æ ¸å¿ƒå‡½æ•°ä¹‹ä¸€ï¼Œå…¶æœ€ç»ˆè°ƒç”¨äº†<code>vmx_x86_ops</code>ä¸­æ³¨å†Œçš„<code>vmx_create_vcpu</code>å‡½æ•°ã€‚</p>
</li>
<li>
<p><code>kvm_get_kvm(kvm)</code>:æ¯åˆ›å»ºä¸€ä¸ª<code>vCPU</code>å°±å°†è¯¥è™šæ‹Ÿæœºå¯¹åº”çš„<code>kvm-&gt;users_count</code>åŠ <code>1</code>ã€‚</p>
</li>
<li>
<p><strong><code>create_vcpu_fd(vcpu)</code></strong>:ä¸ºæ–°åˆ›å»ºçš„<code>vcpu</code>å…³è”ä¸€ä¸ªåŒ¿åæ–‡ä»¶å¹¶ä¸”è¿”å›æ­¤åŒ¿åæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ä½œä¸ºå½“å‰<code>vcpu</code>çš„<code>fd</code>ï¼Œæ­¤<code>fd</code>è¿”å›ç»™<code>kvmtool</code>ä½¿ç”¨ï¼›<code>fd</code>æ‰€å…³è”çš„<code>file_operations</code>ä¸º<code>kvm_vcpu_fops</code>ã€‚</p>
</li>
<li>
<p><strong><code>kvm_arch_vcpu_postcreate(vcpu)</code></strong>: åˆ†åˆ«è°ƒç”¨<code>vmx_vcpu_load</code>å’Œ<code>vmx_vcpu_put</code>ã€‚</p>
</li>
</ul>
<h3 id="kvm-1"><code>kvm</code></h3>
<p>ç”±äºåœ¨åˆ›å»º<code>vcpu</code>æ—¶ï¼Œ<code>kvmtool</code>ä¾§åªéœ€è°ƒç”¨<code>KVM_CREATE_VCPU</code>å³å¯ã€‚å› æ­¤æ¥ä¸‹æ¥é‡ç‚¹åˆ†æ<code>kvm</code>ä¾§çš„ä»£ç ã€‚<code>kvm</code>ä¾§ä»£ç å‚è€ƒå¦‚ä¸‹å›¾:
<img src="/post/kernel/virtualization/cpu%E8%99%9A%E6%8B%9F%E5%8C%96/kvm_vm_ioctl_create_vcpu.png"
	width="2148"
	height="1518"
	srcset="/post/kernel/virtualization/cpu%E8%99%9A%E6%8B%9F%E5%8C%96/kvm_vm_ioctl_create_vcpu_hu4f24330b1d98bdedaa8a12f6f6da87fc_316418_480x0_resize_box_3.png 480w, /post/kernel/virtualization/cpu%E8%99%9A%E6%8B%9F%E5%8C%96/kvm_vm_ioctl_create_vcpu_hu4f24330b1d98bdedaa8a12f6f6da87fc_316418_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="kvm_vm_ioctl_create_vcpu"
	
	
		class="gallery-image" 
		data-flex-grow="141"
		data-flex-basis="339px"
	
></p>
<h4 id="kvm_arch_vcpu_create"><code>kvm_arch_vcpu_create</code></h4>
<p>ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œ<code>kvm</code>ä¾§åˆ›å»º<code>vCPU</code>æ—¶<code>kvm_arch_vcpu_create</code>æ‰®æ¼”äº†åŠå…¶é‡è¦çš„è§’è‰²:</p>
<ul>
<li>
<p>è°ƒç”¨<code>vmx_create_vcpu</code>å‡½æ•°:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">int</span> <span style="color:#008b45">vmx_create_vcpu</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vcpu *vcpu)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> vmx_uret_msr *tsx_ctrl;
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> vcpu_vmx *vmx;
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">int</span> i, err;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>	vmx = <span style="color:#008b45">to_vmx</span>(vcpu);
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">INIT_LIST_HEAD</span>(&amp;vmx-&gt;pi_wakeup_list);
</span></span><span style="display:flex;"><span>	vmx-&gt;vpid = <span style="color:#008b45">allocate_vpid</span>();
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>	err = <span style="color:#008b45">alloc_loaded_vmcs</span>(&amp;vmx-&gt;vmcs01);
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>	vmx-&gt;loaded_vmcs = &amp;vmx-&gt;vmcs01;
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">0</span>;
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>free_vpid:
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">free_vpid</span>(vmx-&gt;vpid);
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">return</span> err;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p>è°ƒç”¨<code>alloc_loaded_vmcs</code>åˆ†é…<code>struct vmcs</code>ç»“æ„ã€‚å°†æ–°åˆ†é…çš„<code>vmcs</code>æ‰€å…³è”çš„é€»è¾‘<code>cpu</code>å­—æ®µè®¾ç½®ä¸º<code>-1(loaded_vmcs-&gt;cpu = -1)</code>ï¼Œè¡¨ç¤ºæ­¤<code>vmcs</code>æœªç»‘å®šåˆ°ä»»ä½•é€»è¾‘<code>cpu</code>ï¼›å°†æ–°åˆ†é…çš„<code>vmcs</code>æ‰€å…³è”çš„<code>launche</code>è®¾ç½®ä¸º<code>0</code>è¡¨ç¤ºæ­¤<code>vmcs</code>ä¸ºé<code>launched</code>ï¼Œåç»­<code>VM entry</code>åº”è¯¥ä½¿ç”¨<code>VMLAUNCH</code>æŒ‡ä»¤ï¼Œè‹¥<code>loaded_vmcs-&gt;launched == 1</code>ï¼Œåç»­<code>VM entry</code>åº”è¯¥ä½¿ç”¨<code>VMRESUME</code>æŒ‡ä»¤ã€‚</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">int</span> <span style="color:#008b45">alloc_loaded_vmcs</span>(<span style="color:#8b008b;font-weight:bold">struct</span> loaded_vmcs *loaded_vmcs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    loaded_vmcs-&gt;vmcs = <span style="color:#008b45">alloc_vmcs</span>(<span style="color:#658b00">false</span>);
</span></span><span style="display:flex;"><span>    ...;
</span></span><span style="display:flex;"><span>    <span style="color:#008b45">vmcs_clear</span>(loaded_vmcs-&gt;vmcs);
</span></span><span style="display:flex;"><span>    ...;
</span></span><span style="display:flex;"><span>    loaded_vmcs-&gt;cpu = -<span style="color:#b452cd">1</span>;
</span></span><span style="display:flex;"><span>	loaded_vmcs-&gt;launched = <span style="color:#b452cd">0</span>;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>struct loaded_vmcs</code>å®šä¹‰å¦‚ä¸‹:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * Track a VMCS that may be loaded on a certain CPU. If it is (cpu!=-1), also
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * remember whether it was VMLAUNCHed, and maintain a linked list of all VMCSs
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * loaded on this CPU (so we can clear them if the CPU goes down).
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">struct</span> loaded_vmcs {
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> vmcs *vmcs;
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> vmcs *shadow_vmcs;
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">int</span> cpu;
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">bool</span> launched;
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">bool</span> nmi_known_unmasked;
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">bool</span> hv_timer_soft_disabled;
</span></span><span style="display:flex;"><span>	<span style="color:#228b22">/* Support for vnmi-less CPUs */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">int</span> soft_vnmi_blocked;
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">ktime_t</span> entry_time;
</span></span><span style="display:flex;"><span>	s64 vnmi_blocked_time;
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">long</span> *msr_bitmap;
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> list_head loaded_vmcss_on_cpu_link;
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> vmcs_host_state host_state;
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> vmcs_controls_shadow controls_shadow;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>struct vmcs</code>å®šä¹‰å¦‚ä¸‹:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">struct</span> vmcs {
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> vmcs_hdr hdr;
</span></span><span style="display:flex;"><span>	u32 abort;
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">char</span> data[];
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>struct vmcs_hdr</code>:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">struct</span> vmcs_hdr {
</span></span><span style="display:flex;"><span>	u32 revision_id:<span style="color:#b452cd">31</span>;
</span></span><span style="display:flex;"><span>	u32 shadow_vmcs:<span style="color:#b452cd">1</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ ¹æ®<code>Intel SDM</code>æè¿°:</p>
<ul>
<li><code>vmcs.vmcs_hdr.revision_id</code>è¡¨ç¤º<code>VMCS revision</code>æ ‡è¯†ç¬¦ï¼Œå ç”¨ç¬¬ä¸€ä¸ª<code>4</code>å­—èŠ‚æ•°æ®çš„<code>0-30</code>ä½ã€‚</li>
<li><code>vmcs.vmcs_hdr.shadow_vmcs</code>å ç”¨ç¬¬ä¸€ä¸ª<code>4</code>å­—èŠ‚æ•°æ®çš„ç¬¬<code>31</code>ä½ï¼ŒæŒ‡ç¤ºå½“å‰<code>vmcs</code>æ˜¯å¦ä¸º<code>shadow-VMCS</code>ã€‚</li>
<li><code>vmcs.abort</code>å®Œå…¨å ç”¨ç¬¬äºŒä¸ª<code>4</code>å­—èŠ‚æ•°æ®ï¼Œè¡¨ç¤º<code>VMX</code>ä¸­æ­¢æŒ‡ç¤ºï¼Œ<code>VM-Exit</code>æ‰§è¡Œä¸æˆåŠŸæ—¶äº§ç”Ÿ<code>VMX</code>ä¸­æ­¢ï¼Œ<code>CPU</code>ä¼šåœ¨æ­¤å¤„å­˜å…¥<code>VMX</code>ä¸­æ­¢çš„åŸå› ï¼Œä»¥æ–¹ä¾¿è°ƒè¯•ã€‚</li>
<li><strong><code>vmcs.data</code>ä¸º<code>vmcs</code>çš„æ•°æ®åŸŸï¼Œæ­¤å­—æ®µä¸­çš„æ•°æ®æ˜¯ç‰¹å®šäº<code>cpu</code>çš„ã€‚</strong></li>
</ul>
<p><img src="/post/kernel/virtualization/cpu%E8%99%9A%E6%8B%9F%E5%8C%96/intel_sdm_vmcs.png"
	width="1101"
	height="420"
	srcset="/post/kernel/virtualization/cpu%E8%99%9A%E6%8B%9F%E5%8C%96/intel_sdm_vmcs_huff49e581260e6f6b8d891d9f289381b8_55698_480x0_resize_box_3.png 480w, /post/kernel/virtualization/cpu%E8%99%9A%E6%8B%9F%E5%8C%96/intel_sdm_vmcs_huff49e581260e6f6b8d891d9f289381b8_55698_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="intel_sdm_vmcs"
	
	
		class="gallery-image" 
		data-flex-grow="262"
		data-flex-basis="629px"
	
></p>
<ol start="2">
<li>
<p>åœ¨éåµŒå¥—è™šæ‹ŸåŒ–ç¯å¢ƒä¸‹ï¼Œå°†<code>vmx-&gt;loaded_vmcs</code>è®¾ç½®ä¸º<code>&amp;vmx-&gt;vmcs01</code>ï¼Œå‚è€ƒå¦‚ä¸‹è¯´æ˜:</p>
<blockquote>
<p>â€‹	/*</p>
<p>â€‹     ** loaded_vmcs points to the VMCS currently used in this vcpu. For a*</p>
<p>â€‹     ** non-nested (L1) guest, it always points to vmcs01. For a nested*</p>
<p>â€‹     ** guest (L2), it points to a different VMCS.*</p>
<p>â€‹     *<em>/</em></p>
</blockquote>
</li>
</ol>
</li>
</ol>
</li>
<li>
<p>ç»ç”±<code>vcpu_load(vcpu)</code>è°ƒç”¨<code>vmx_vcpu_load(struct kvm_vcpu *vcpu, int cpu)</code>ï¼Œæœ€åè°ƒç”¨<code>vmx_vcpu_load_vmcs(*vcpu*, *cpu*, NULL)</code>ä¸­çš„<code>vmcs_load</code>å‡½æ•°å°†<code>vmcs</code>ä¸å½“å‰é€»è¾‘<code>cpu</code>ç»‘å®šã€‚å¦‚ä¸‹å‡½æ•°é€»è¾‘è§ä»£ç ä¸­</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">vmx_vcpu_load_vmcs</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vcpu *vcpu, <span style="color:#00688b;font-weight:bold">int</span> cpu,
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">struct</span> loaded_vmcs *buddy)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> vcpu_vmx *vmx = <span style="color:#008b45">to_vmx</span>(vcpu);
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * vmcså…³è”çš„é€»è¾‘cpuæ˜¯å¦æ˜¯å½“å‰é€»è¾‘cpu,ä»¥æ­¤ä½œä¸ºvmcsæ˜¯å¦å·²ç»loadedçš„ä¾æ®
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">bool</span> already_loaded = vmx-&gt;loaded_vmcs-&gt;cpu == cpu;
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> vmcs *prev;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * vmcsæœªè¢«loaded
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (!already_loaded) {
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">loaded_vmcs_clear</span>(vmx-&gt;loaded_vmcs);
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">local_irq_disable</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 * Ensure loaded_vmcs-&gt;cpu is read before adding loaded_vmcs to
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 * this cpu&#39;s percpu list, otherwise it may not yet be deleted
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 * from its previous cpu&#39;s percpu list.  Pairs with the
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 * smb_wmb() in __loaded_vmcs_clear().
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">smp_rmb</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">         * å°†vmx-&gt;loaded_vmcsæ·»åŠ åˆ°å½“å‰é€»è¾‘cpuçš„loaded_vmcss_on_cpué“¾è¡¨ä¸Š
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">         */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">list_add</span>(&amp;vmx-&gt;loaded_vmcs-&gt;loaded_vmcss_on_cpu_link,
</span></span><span style="display:flex;"><span>			 &amp;<span style="color:#008b45">per_cpu</span>(loaded_vmcss_on_cpu, cpu));
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">local_irq_enable</span>();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * å–å‡ºå½“å‰é€»è¾‘cpuçš„current_vmcsä¸vmx-&gt;loaded_vmcs-&gt;vmcsåšæ¯”è¾ƒ
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * è‹¥ä¸ç›¸ç­‰ï¼Œè¡¨ç¤ºéœ€è¦æ›´æ–°å½“å‰é€»è¾‘cpuçš„current_vmcs
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * ç„¶åä½¿ç”¨vmptrldæŒ‡ä»¤å°†vmx-&gt;loaded_vmcs-&gt;vmcsä¸å½“å‰é€»è¾‘cpuç»‘å®š
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     */</span>
</span></span><span style="display:flex;"><span>	prev = <span style="color:#008b45">per_cpu</span>(current_vmcs, cpu);
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (prev != vmx-&gt;loaded_vmcs-&gt;vmcs) {
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">per_cpu</span>(current_vmcs, cpu) = vmx-&gt;loaded_vmcs-&gt;vmcs;
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">vmcs_load</span>(vmx-&gt;loaded_vmcs-&gt;vmcs);
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (!already_loaded) {
</span></span><span style="display:flex;"><span>		...;
</span></span><span style="display:flex;"><span>		<span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 * å°†vmx-&gt;loaded_vmcsæ‰€å…³è”çš„é€»è¾‘cpuè®¾ç½®ä¸ºå½“å‰é€»è¾‘cpu
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 */</span>
</span></span><span style="display:flex;"><span>		vmx-&gt;loaded_vmcs-&gt;cpu = cpu;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>kvm_vcpu_reset(vcpu, false)</code>æœ€ç»ˆè°ƒç”¨<code>vmx_vcpu_reset</code>ï¼Œ<code>vmx_set_cr0</code>ï¼Œ<code>vmx_set_cr4</code>ï¼Œ<code>vmx_set_eferr</code>ï¼Œ<code>vmx_update_exception_bitmap</code>è®¾ç½®<code>vmcs</code>ä¸­<code>data</code>åŸŸçš„å€¼ã€‚è®¾ç½®<code>vmcs</code>æ—¶ï¼Œç”±å‡½æ•°<code>vmcs_writeX</code>æ‰§è¡Œ<code>vmwrite</code>æŒ‡ä»¤å†™ç›¸å…³çš„åŸŸã€‚</p>
</li>
</ul>
<h4 id="kvm_get_kvm"><code>kvm_get_kvm</code></h4>
<p><code>kvm_get_kvm</code>å‡½æ•°å°†<code>struct kvm</code>ä¸­çš„æˆå‘˜å˜é‡<code>users_count</code>åŸå­çš„åŠ <code>1</code>ï¼Œè¡¨ç¤ºå¼•ç”¨æ­¤<code>struct kvm</code>çš„æˆå‘˜æ•°é‡ã€‚</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">kvm_get_kvm</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm *kvm)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">refcount_inc</span>(&amp;kvm-&gt;users_count);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#008b45">EXPORT_SYMBOL_GPL</span>(kvm_get_kvm);
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨è°ƒç”¨<code>kvm_put_kvm</code>å‡½æ•°æ—¶ï¼Œé¦–å…ˆæ£€æµ‹<code>kvm-&gt;users_count</code>æ˜¯å¦ä¸º<code>0</code>ï¼Œè‹¥ä¸º<code>0</code>åˆ™é”€æ¯è™šæ‹Ÿæœºã€‚ä»£ç å‚è§å¦‚ä¸‹:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">kvm_put_kvm</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm *kvm)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (<span style="color:#008b45">refcount_dec_and_test</span>(&amp;kvm-&gt;users_count))
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">kvm_destroy_vm</span>(kvm);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#008b45">EXPORT_SYMBOL_GPL</span>(kvm_put_kvm);
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="create_vcpu_fd"><code>create_vcpu_fd</code></h4>
<p>ä¸ºæ–°åˆ›å»ºçš„<code>vcpu</code>å…³è”ä¸€ä¸ªåŒ¿åæ–‡ä»¶å¹¶ä¸”è¿”å›æ­¤åŒ¿åæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ä½œä¸ºå½“å‰<code>vcpu-fd</code>ï¼Œæ­¤<code>vcpu-fd</code>è¿”å›ç»™<code>kvmtool</code>ä½¿ç”¨ã€‚</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * Allocates an inode for the vcpu.
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">int</span> <span style="color:#008b45">create_vcpu_fd</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vcpu *vcpu)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">char</span> name[<span style="color:#b452cd">8</span> + <span style="color:#b452cd">1</span> + ITOA_MAX_LEN + <span style="color:#b452cd">1</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">snprintf</span>(name, <span style="color:#8b008b;font-weight:bold">sizeof</span>(name), <span style="color:#cd5555">&#34;kvm-vcpu:%d&#34;</span>, vcpu-&gt;vcpu_id);
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#008b45">anon_inode_getfd</span>(name, &amp;kvm_vcpu_fops, vcpu, O_RDWR | O_CLOEXEC);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>vcpu-fd</code>æ‰€å…³è”çš„<code>file_operations</code>ä¸º<code>kvm_vcpu_fops</code>:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">struct</span> file_operations kvm_vcpu_fops = {
</span></span><span style="display:flex;"><span>    .release        = kvm_vcpu_release,
</span></span><span style="display:flex;"><span>    .unlocked_ioctl = kvm_vcpu_ioctl,
</span></span><span style="display:flex;"><span>    .mmap           = kvm_vcpu_mmap,
</span></span><span style="display:flex;"><span>    .llseek        = noop_llseek,
</span></span><span style="display:flex;"><span>    <span style="color:#008b45">KVM_COMPAT</span>(kvm_vcpu_compat_ioctl),
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="kvm_arch_vcpu_postcreate"><code>kvm_arch_vcpu_postcreate</code></h4>
<p>æ ¹æ®ä»£ç çœ‹ï¼Œ<code>kvm_arch_vcpu_postcreate</code>æœ€ç»ˆè°ƒç”¨äº†<code>vmx_vcpu_load</code>ä»¥åŠ<code>vmx_vcpu_put</code>ã€‚æ ¹æ®ä¹‹å‰<code>kvm_arch_vcpu_create</code>æµç¨‹åˆ†æï¼Œæ­¤æ—¶åœ¨<code>kvm_arch_vcpu_postcreate</code>ä¸­è°ƒç”¨<code>vmx_vcpu_load</code>å’Œ<code>vmx_vcpu_put</code>çš„ä½œç”¨ä¸æ˜¯å¤ªæ¸…æ¥šã€‚</p>
<p>è‡³æ­¤ï¼Œæ•´ä¸ª<code>KVM_CREATE_VCPU</code>çš„æµç¨‹å°±åˆ†æå®Œæ¯•äº†ã€‚</p>
<h2 id="kvmtoolä¸kvmä¹‹é—´çš„å…±äº«æ•°æ®"><code>kvmtool</code>ä¸<code>kvm</code>ä¹‹é—´çš„å…±äº«æ•°æ®</h2>
<p>åœ¨æ‰§è¡Œ<code>KVM_RUN</code>è°ƒç”¨ä¹‹å‰ï¼Œ<code>kvmtool</code>ä¸<code>kvm</code>éœ€è¦åˆ†é…ä¸€å—å…±äº«å†…å­˜ç”¨äºå…±äº«æ•°æ®ã€‚é¦–å…ˆï¼Œ<code>kvmtool</code>è°ƒç”¨<code>KVM_GET_VCPU_MMAP_SIZE</code>è·å–æ­¤å…±äº«å†…å­˜çš„å¤§å°ï¼Œç„¶åä½¿ç”¨<code>mmap</code>åœ¨<code>kvmtool</code>è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´åˆ›å»ºä¸€ä¸ªæ–°çš„æ˜ å°„ã€‚ä»£ç å‚è€ƒå¦‚ä¸‹:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>mmap_size = <span style="color:#008b45">ioctl</span>(vcpu-&gt;kvm-&gt;sys_fd, KVM_GET_VCPU_MMAP_SIZE, <span style="color:#b452cd">0</span>);
</span></span><span style="display:flex;"><span>...;
</span></span><span style="display:flex;"><span>vcpu-&gt;kvm_run = <span style="color:#008b45">mmap</span>(<span style="color:#658b00">NULL</span>, mmap_size, PROT_RW, MAP_SHARED, vcpu-&gt;vcpu_fd, <span style="color:#b452cd">0</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="kvm-2"><code>kvm</code></h3>
<p>ä»<code>kvmtool</code>ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œ<code>KVM_GET_VCPU_MMAP_SIZE</code>åœ¨è°ƒç”¨<code>ioctl</code>æ—¶ä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ä¸º<code>kvm-fd</code>ï¼Œå› æ­¤å…¶å…¥å£æ˜¯<code>kvm_dev_ioctl</code>ã€‚</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">long</span> <span style="color:#008b45">kvm_dev_ioctl</span>(<span style="color:#8b008b;font-weight:bold">struct</span> file *filp,
</span></span><span style="display:flex;"><span>			  <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> ioctl, <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">long</span> arg)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">long</span> r = -EINVAL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">switch</span> (ioctl) {
</span></span><span style="display:flex;"><span>	...;
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">case</span> KVM_GET_VCPU_MMAP_SIZE:
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">if</span> (arg)
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">goto</span> out;
</span></span><span style="display:flex;"><span>		r = PAGE_SIZE;     <span style="color:#228b22">/* struct kvm_run */</span>
</span></span><span style="display:flex;"><span><span style="color:#1e889b">#ifdef CONFIG_X86
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>		r += PAGE_SIZE;    <span style="color:#228b22">/* pio data page */</span>
</span></span><span style="display:flex;"><span><span style="color:#1e889b">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#ifdef CONFIG_KVM_MMIO
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>		r += PAGE_SIZE;    <span style="color:#228b22">/* coalesced mmio ring page */</span>
</span></span><span style="display:flex;"><span><span style="color:#1e889b">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>		<span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>        ...;
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ä»£ç è¯´æ˜åœ¨<code>kvmtool</code>åœ¨è°ƒç”¨<code>KVM_GET_VCPU_MMAP_SIZE</code>å<code>mmap_size</code>çš„å¤§å°æœ€å°ä¸º<code>1</code>ä¸ª<code>PAGE_SIZE</code>ï¼Œæœ€å¤šä¸º<code>3</code>ä¸ª<code>PAGE_SIZE</code>ã€‚ç¬¬ä¸€ä¸ªé¡µé¢ç”¨äº<code>struct kvm_run</code>ï¼Œç¬¬äºŒä¸ªé¡µé¢ç”¨äº<code>pio data page</code>ï¼Œç¬¬ä¸‰ä¸ªé¡µé¢ç”¨äº<code>coalesced mmio ring page</code>ã€‚å…·ä½“çš„å¤§å°ä¸<code>CONFIG_X86</code>ä»¥åŠ<code>CONFIG_KVM_MMIO</code>æœ‰å…³ã€‚å¯å‚è§å†…æ ¸å…³äº<code>KVM_GET_VCPU_MMAP_SIZE</code>çš„æ–‡æ¡£è¯´æ˜:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#b452cd">4.5</span> KVM_GET_VCPU_MMAP_SIZE
</span></span><span style="display:flex;"><span>--------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>:Capability: basic
</span></span><span style="display:flex;"><span>:Architectures: all
</span></span><span style="display:flex;"><span>:Type: system ioctl
</span></span><span style="display:flex;"><span>:Parameters: none
</span></span><span style="display:flex;"><span>:Returns: size of vcpu mmap area, in bytes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The KVM_RUN <span style="color:#008b45">ioctl</span> (cf.) communicates with userspace via a shared
</span></span><span style="display:flex;"><span>memory region.  This ioctl returns the size of that region.  See the
</span></span><span style="display:flex;"><span>KVM_RUN documentation <span style="color:#8b008b;font-weight:bold">for</span> details.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Besides the size of the KVM_RUN communication region, other areas of
</span></span><span style="display:flex;"><span>the VCPU file descriptor can be mmap-ed, including:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#8b008b;font-weight:bold">if</span> KVM_CAP_COALESCED_MMIO is available, a page at
</span></span><span style="display:flex;"><span>  KVM_COALESCED_MMIO_PAGE_OFFSET * PAGE_SIZE; <span style="color:#8b008b;font-weight:bold">for</span> historical reasons,
</span></span><span style="display:flex;"><span>  this page is included in the result of KVM_GET_VCPU_MMAP_SIZE.
</span></span><span style="display:flex;"><span>  KVM_CAP_COALESCED_MMIO is not documented yet.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#8b008b;font-weight:bold">if</span> KVM_CAP_DIRTY_LOG_RING is available, a number of pages at
</span></span><span style="display:flex;"><span>  KVM_DIRTY_LOG_PAGE_OFFSET * PAGE_SIZE.  For more information on
</span></span><span style="display:flex;"><span>  KVM_CAP_DIRTY_LOG_RING, see section <span style="color:#b452cd">8.3</span>.
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>kvmtool</code>å¾—åˆ°å…±äº«å†…å­˜çš„å¤§å°ååœ¨<code>vcpu-fd</code>ä¸Šè°ƒç”¨<code>mmap</code>ï¼Œ<code>vcpu-fd</code>æ‰€å…³è”çš„<code>file_operations</code>ä¸º<code>kvm_vcpu_fops</code>å› æ­¤ä¼šè°ƒç”¨åˆ°<code>kvm_vcpu_mmap</code>:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">int</span> <span style="color:#008b45">kvm_vcpu_mmap</span>(<span style="color:#8b008b;font-weight:bold">struct</span> file *file, <span style="color:#8b008b;font-weight:bold">struct</span> vm_area_struct *vma)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vcpu *vcpu = file-&gt;private_data;
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">long</span> pages = <span style="color:#008b45">vma_pages</span>(vma);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> ((<span style="color:#008b45">kvm_page_in_dirty_ring</span>(vcpu-&gt;kvm, vma-&gt;vm_pgoff) ||
</span></span><span style="display:flex;"><span>	     <span style="color:#008b45">kvm_page_in_dirty_ring</span>(vcpu-&gt;kvm, vma-&gt;vm_pgoff + pages - <span style="color:#b452cd">1</span>)) &amp;&amp;
</span></span><span style="display:flex;"><span>	    ((vma-&gt;vm_flags &amp; VM_EXEC) || !(vma-&gt;vm_flags &amp; VM_SHARED)))
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">return</span> -EINVAL;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// è®¾ç½® vma-&gt;vm_ops ä¸ºkvm_vcpu_vm_ops
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>	vma-&gt;vm_ops = &amp;kvm_vcpu_vm_ops;
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>kvmtool</code>è°ƒç”¨<code>mmap</code>æ˜ å°„<code>vcpu-fd</code>å…³è”çš„åŒ¿åæ–‡ä»¶æ—¶ï¼Œä»…ä»…åˆ†é…äº†è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œç„¶åè®¾ç½®è¿™æ®µè™šæ‹Ÿåœ°å€ç©ºé—´çš„æ“ä½œä¸º<code>kvm_vcpu_vm_ops</code>ï¼Œè¯¥æ“ä½œåªæœ‰ä¸€ä¸ª<code>fault</code>å›è°ƒå‡½æ•°<code>kvm_vcpu_fault</code>ã€‚</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#8b008b;font-weight:bold">struct</span> vm_operations_struct kvm_vcpu_vm_ops = {
</span></span><span style="display:flex;"><span>	.fault = kvm_vcpu_fault,
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>kvm_vcpu_fault</code>å‡½æ•°ä¼šåœ¨<code>kvmtool</code>è®¿é—®å…±äº«å†…å­˜äº§ç”Ÿç¼ºé¡µå¼‚å¸¸çš„æ—¶å€™è¢«è°ƒç”¨:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">vm_fault_t</span> <span style="color:#008b45">kvm_vcpu_fault</span>(<span style="color:#8b008b;font-weight:bold">struct</span> vm_fault *vmf)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vcpu *vcpu = vmf-&gt;vma-&gt;vm_file-&gt;private_data;
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> page *page;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (vmf-&gt;pgoff == <span style="color:#b452cd">0</span>)
</span></span><span style="display:flex;"><span>		page = <span style="color:#008b45">virt_to_page</span>(vcpu-&gt;run);
</span></span><span style="display:flex;"><span><span style="color:#1e889b">#ifdef CONFIG_X86
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>	<span style="color:#8b008b;font-weight:bold">else</span> <span style="color:#8b008b;font-weight:bold">if</span> (vmf-&gt;pgoff == KVM_PIO_PAGE_OFFSET)
</span></span><span style="display:flex;"><span>		page = <span style="color:#008b45">virt_to_page</span>(vcpu-&gt;arch.pio_data);
</span></span><span style="display:flex;"><span><span style="color:#1e889b">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#ifdef CONFIG_KVM_MMIO
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>	<span style="color:#8b008b;font-weight:bold">else</span> <span style="color:#8b008b;font-weight:bold">if</span> (vmf-&gt;pgoff == KVM_COALESCED_MMIO_PAGE_OFFSET)
</span></span><span style="display:flex;"><span>		page = <span style="color:#008b45">virt_to_page</span>(vcpu-&gt;kvm-&gt;coalesced_mmio_ring);
</span></span><span style="display:flex;"><span><span style="color:#1e889b">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>	<span style="color:#8b008b;font-weight:bold">else</span> <span style="color:#8b008b;font-weight:bold">if</span> (<span style="color:#008b45">kvm_page_in_dirty_ring</span>(vcpu-&gt;kvm, vmf-&gt;pgoff))
</span></span><span style="display:flex;"><span>		page = <span style="color:#008b45">kvm_dirty_ring_get_page</span>(
</span></span><span style="display:flex;"><span>		    &amp;vcpu-&gt;dirty_ring,
</span></span><span style="display:flex;"><span>		    vmf-&gt;pgoff - KVM_DIRTY_LOG_PAGE_OFFSET);
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#008b45">kvm_arch_vcpu_fault</span>(vcpu, vmf);
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">get_page</span>(page);
</span></span><span style="display:flex;"><span>	vmf-&gt;page = page;
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ ¹æ®ä»£ç :</p>
<ul>
<li>è®¿é—®ç¬¬ä¸€é¡µçš„æ—¶å€™ï¼Œå®é™…ä¸Šä¼šè®¿é—®åˆ°<code>struct kvm_vcpu</code>ä¸­çš„<code>run(struct kvm_run)</code>æˆå‘˜ã€‚</li>
<li>è®¿é—®ç¬¬äºŒé¡µçš„æ—¶å€™ï¼Œå®é™…ä¸Šä¼šè®¿é—®åˆ°<code>struct kvm_vcpu</code>ä¸­çš„<code>arch(struct kvm_vcpu_arch)</code>æˆå‘˜ã€‚</li>
<li>è®¿é—®ç¬¬ä¸‰é¡µçš„æ—¶å€™ï¼Œå®é™…ä¸Šä¼šè®¿é—®åˆ°å½“å‰<code>struct kvm</code>ä¸­çš„<code>coalesced_mmio_ring</code>æˆå‘˜ã€‚</li>
</ul>
<p>å¦‚æœè®¿é—®çš„åœ°å€è¶…è¿‡äº†æŒ‡å®šçš„é•¿åº¦ï¼Œåˆ™è°ƒç”¨<code>kvm_arch_vcpu_fault</code>è¿”å›<code>VM_FAULT_SIGBUS</code>:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">vm_fault_t</span> <span style="color:#008b45">kvm_arch_vcpu_fault</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vcpu *vcpu, <span style="color:#8b008b;font-weight:bold">struct</span> vm_fault *vmf)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">return</span> VM_FAULT_SIGBUS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="vcpuçš„è¿è¡Œ"><code>vCPU</code>çš„è¿è¡Œ</h2>
<p>åœ¨æ—§ç‰ˆæœ¬çš„<code>Intel SDM</code>ä¸­ï¼Œæè¿°äº†è®©ä¸€ä¸ªè™šæ‹Ÿæœºè¿è¡Œèµ·æ¥çš„æ­¥éª¤:</p>
<ol>
<li>åœ¨éåˆ†é¡µå†…å­˜ä¸­åˆ†é…ä¸€ä¸ª<code>4KB</code>å¯¹é½çš„<code>vmcs</code>åŒºåŸŸï¼Œå…¶å¤§å°é€šè¿‡<code>IA32_VMX_BASIC MSR</code>å¾—åˆ°ã€‚å¯¹äº<code>kvm</code>ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸»è¦æ˜¯é€šè¿‡<code>vmx_create_vcpu</code>è°ƒç”¨<code>alloc_vmcs</code>æ¥å®Œæˆã€‚</li>
<li>åˆå§‹åŒ–<code>vmcs</code>çš„ç‰ˆæœ¬æ ‡è¯†ï¼Œè¿™ä¸ªè¿‡ç¨‹åœ¨<code>alloc_vmcs_cpu</code>ä¸­å®Œæˆã€‚</li>
<li>ä½¿ç”¨<code>vmcs</code>çš„ç‰©ç†åœ°å€<code>hpa</code>ä½œä¸ºæ“ä½œæ•°æ‰§è¡Œ<code>vmclear</code>æŒ‡ä»¤ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸»è¦é€šè¿‡<code>loaded_vmcs_clear</code>å‡½æ•°æœ€ç»ˆè°ƒç”¨<code>vmcs_clear</code>æ¥å®Œæˆã€‚å¦‚æœæ“ä½œæ•°æ˜¯æŒ‡å‘<code>current vmcs</code>çš„æŒ‡é’ˆï¼Œæ‰§è¡Œ<code>vmclear</code>æŒ‡ä»¤åï¼ŒæŒ‡é’ˆä¼šè¢«ç½®ä¸º<code>FFFFFFFF_FFFFFFFFH</code>ã€‚</li>
<li>ä½¿ç”¨<code>vmcs</code>çš„ç‰©ç†åœ°å€ä½œä¸ºæ“ä½œæ•°æ‰§è¡Œ<code>vmptrld</code>ã€‚è¿™ä¸ªè¿‡ç¨‹ç”±<code>vmx_cpu_load</code>è°ƒç”¨<code>vmcs_load</code>æ¥å®Œæˆã€‚</li>
<li>æ‰§è¡Œ<code>vmwrite</code>æŒ‡ä»¤è®¾ç½®åˆå§‹åŒ–<code>vmcs</code>ï¼Œåœ¨<code>kvm</code>ä¸­è¿™ä¸ªè¿‡ç¨‹ç”±<code>vmx_vcpu_reset</code>å®Œæˆã€‚</li>
<li>æ‰§è¡Œ<code>vmlaunch</code>æŒ‡ä»¤ï¼Œä½¿å¾—å½“å‰é€»è¾‘<code>cpu</code>å¤„äº<code>VMX non-root</code>æ¨¡å¼ã€‚è¿™ä¸ªè¿‡ç¨‹ç”±<code>vmx_vcpu_run</code>æ¥å®Œæˆã€‚</li>
</ol>
<p>æ­¥éª¤<code>1-5</code>åœ¨æœ¬æ–‡æ¡£ä¹‹å‰å·²ç»åšè¿‡åˆ†æï¼Œ<code>6</code>å°±æ˜¯æœ¬å°èŠ‚çš„é‡ç‚¹ã€‚åŒæ ·ï¼Œ<code>vCPU</code>è¿è¡Œéœ€è¦<code>kvmtool</code>å’Œ<code>kvm</code>é…åˆä¸€èµ·æ‰èƒ½å®Œæˆã€‚åœ¨<code>kvmtool</code>ä¾§ä¸€ä¸ª<code>vCPU</code>å…¶å®å¯¹åº”ä¸€ä¸ªç”¨æˆ·æ€çº¿ç¨‹ï¼Œå…¶åˆ›å»ºå®Œæˆåï¼Œä¼šè¿›å…¥å¾ªç¯çŠ¶æ€ï¼Œç­‰å¾…æ¡ä»¶æ»¡è¶³æ—¶å¼€å§‹è¿è¡Œè™šæ‹Ÿæœºä»£ç ã€‚è™šæ‹Ÿæœºæ‰§è¡Œæ•æ„ŸæŒ‡ä»¤æˆ–æ”¶åˆ°å¤–éƒ¨ä¸­æ–­æ—¶ï¼Œä¾¿ä¼šè§¦å‘<code>VM-Exit</code>è¿›å…¥<code>kvm</code>æ¨¡å—å¤„ç†ï¼›éƒ¨åˆ†<code>VM-Exit</code>ç”šè‡³ä¼šé€€å‡ºåˆ°<code>kvmtool</code>ä¸­è¿›è¡Œå¤„ç†ã€‚å¦‚ä¸‹ä»£ç ä¸º<code>kvmtool</code>ä¸­åˆ›å»º<code>vCPU</code>çº¿ç¨‹:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">int</span> <span style="color:#008b45">kvm_cmd_run_work</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm *kvm)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">int</span> i;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">for</span> (i = <span style="color:#b452cd">0</span>; i &lt; kvm-&gt;nrcpus; i++) {
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// æ ¹æ®kvm-&gt;nrcpusåˆ›å»ºvcpuçº¿ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>		<span style="color:#8b008b;font-weight:bold">if</span> (<span style="color:#008b45">pthread_create</span>(&amp;kvm-&gt;cpus[i]-&gt;<span style="color:#8b008b;font-weight:bold">thread</span>, <span style="color:#658b00">NULL</span>, kvm_cpu_thread, kvm-&gt;cpus[i]) != <span style="color:#b452cd">0</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#008b45">die</span>(<span style="color:#cd5555">&#34;unable to create KVM VCPU thread&#34;</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#228b22">/* Only VCPU #0 is going to exit by itself when shutting down */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (<span style="color:#008b45">pthread_join</span>(kvm-&gt;cpus[<span style="color:#b452cd">0</span>]-&gt;<span style="color:#8b008b;font-weight:bold">thread</span>, <span style="color:#658b00">NULL</span>) != <span style="color:#b452cd">0</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">die</span>(<span style="color:#cd5555">&#34;unable to join with vcpu 0&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#008b45">kvm_cpu__exit</span>(kvm);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>kvmtool</code>å’Œ<code>kvm</code>äº¤äº’å¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="/post/kernel/virtualization/cpu%E8%99%9A%E6%8B%9F%E5%8C%96/kvm_vcpu_run.png"
	width="1071"
	height="531"
	srcset="/post/kernel/virtualization/cpu%E8%99%9A%E6%8B%9F%E5%8C%96/kvm_vcpu_run_hu845c515536ead87936c1011f6afef30c_79952_480x0_resize_box_3.png 480w, /post/kernel/virtualization/cpu%E8%99%9A%E6%8B%9F%E5%8C%96/kvm_vcpu_run_hu845c515536ead87936c1011f6afef30c_79952_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="kvm_vcpu_run"
	
	
		class="gallery-image" 
		data-flex-grow="201"
		data-flex-basis="484px"
	
></p>
<ul>
<li><code>kvm_cpu__setup_cpuid</code>:ä½¿ç”¨<code>KVM_SET_CPUID2</code>è°ƒç”¨<code>ioctl</code>è®¾ç½®<code>vCPU</code>å¯¹<code>CPUID</code>æŒ‡ä»¤çš„å“åº”ã€‚</li>
<li><code>kvm_cpu__setup_sregs</code>:ä½¿ç”¨<code>KVM_SET_SREGS</code>è°ƒç”¨<code>ioctl</code>è®¾ç½®<code>vCPU</code>ä¸­ç‰¹æ®Šå¯„å­˜å™¨<code>(cs,ss,ds,es,fs,gs)</code>çš„å€¼ã€‚</li>
<li><code>kvm_cpu__setup_regs</code>:ä½¿ç”¨<code>KVM_SET_REGS</code>è°ƒç”¨<code>ioctl</code>è®¾ç½®<code>vCPU</code>ä¸­å¯„å­˜å™¨<code>(rflags,rip,rsp,rbp)</code>çš„å€¼ã€‚</li>
<li><code>kvm_cpu__setup_fpu</code>:ä½¿ç”¨<code>KVM_SET_FPU</code>è°ƒç”¨<code>ioctl</code>è®¾ç½®<code>vCPU</code>ä¸­<code>float point state</code>ã€‚</li>
<li><code>kvm_cpu__setup_msrs</code>:ä½¿ç”¨<code>KVM_SET_MSRS</code>è°ƒç”¨<code>ioctl</code>è®¾ç½®<code>vCPU</code>ä¸­çš„<code>model-specific registers</code>ã€‚</li>
<li><strong><code>kvm_cpu__run</code></strong>:<strong>ä½¿ç”¨<code>KVM_RUN</code>è°ƒç”¨<code>ioctl</code>è¿è¡Œ<code>vCPU</code>ã€‚</strong></li>
</ul>
<p>å‡½æ•°**<code>kvm_cpu__start</code>**æ³¨å†Œè™šæ‹Ÿæœºç›¸å…³çš„ä¿¡å·å¤„ç†å‡½æ•°ï¼Œè®¾ç½®<code>vCPU</code>çš„æŸäº›çŠ¶æ€ä»¥åŠæ ¹æ®<code>vCPU</code>æ˜¯å¦<code>running</code>æ³¨å…¥<code>NMI</code>ï¼Œç„¶åè°ƒç”¨<code>kvm_cpu__run</code>æ‰§è¡Œ<code>ioctl(vcpu-&gt;vcpu_fd, KVM_RUN, 0)</code>ã€‚å½“<code>vCPU</code>å‘ç”Ÿ<code>VM-Exit</code>å¹¶ä¸”<code>kvm</code>æ— æ³•å¤„ç†æ­¤ç±»å‹é€€å‡ºï¼Œå°±è¿”å›åˆ°<code>kvmtool</code>ä¸­æ ¹æ®<code>cpu-&gt;kvm_run-&gt;exit_reason</code>è¿›è¡Œå¤„ç†ã€‚</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">int</span> <span style="color:#008b45">kvm_cpu__start</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm_cpu *cpu)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">sigset_t</span> sigset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">sigemptyset</span>(&amp;sigset);
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">sigaddset</span>(&amp;sigset, SIGALRM);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">pthread_sigmask</span>(SIG_BLOCK, &amp;sigset, <span style="color:#658b00">NULL</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">signal</span>(SIGKVMEXIT, kvm_cpu_signal_handler);
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">signal</span>(SIGKVMPAUSE, kvm_cpu_signal_handler);
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">signal</span>(SIGKVMTASK, kvm_cpu_signal_handler);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">kvm_cpu__reset_vcpu</span>(cpu);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (cpu-&gt;kvm-&gt;cfg.single_step)
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">kvm_cpu__enable_singlestep</span>(cpu);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">while</span> (cpu-&gt;is_running) {
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">if</span> (cpu-&gt;needs_nmi) {
</span></span><span style="display:flex;"><span>			<span style="color:#008b45">kvm_cpu__arch_nmi</span>(cpu);
</span></span><span style="display:flex;"><span>			cpu-&gt;needs_nmi = <span style="color:#b452cd">0</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">if</span> (cpu-&gt;task)
</span></span><span style="display:flex;"><span>			<span style="color:#008b45">kvm_cpu__run_task</span>(cpu);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">kvm_cpu__run</span>(cpu);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">switch</span> (cpu-&gt;kvm_run-&gt;exit_reason) {
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">case</span> KVM_EXIT_UNKNOWN:
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">case</span> KVM_EXIT_DEBUG:
</span></span><span style="display:flex;"><span>			<span style="color:#008b45">kvm_cpu__show_registers</span>(cpu);
</span></span><span style="display:flex;"><span>			<span style="color:#008b45">kvm_cpu__show_code</span>(cpu);
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">case</span> KVM_EXIT_IO: {
</span></span><span style="display:flex;"><span>			<span style="color:#00688b;font-weight:bold">bool</span> ret;
</span></span><span style="display:flex;"><span>			
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// æ¨¡æ‹ŸIO
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>			ret = <span style="color:#008b45">kvm_cpu__emulate_io</span>(cpu,
</span></span><span style="display:flex;"><span>						  cpu-&gt;kvm_run-&gt;io.port,
</span></span><span style="display:flex;"><span>						  (u8 *)cpu-&gt;kvm_run +
</span></span><span style="display:flex;"><span>						  cpu-&gt;kvm_run-&gt;io.data_offset,
</span></span><span style="display:flex;"><span>						  cpu-&gt;kvm_run-&gt;io.direction,
</span></span><span style="display:flex;"><span>						  cpu-&gt;kvm_run-&gt;io.size,
</span></span><span style="display:flex;"><span>						  cpu-&gt;kvm_run-&gt;io.count);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">if</span> (!ret)
</span></span><span style="display:flex;"><span>				<span style="color:#8b008b;font-weight:bold">goto</span> panic_kvm;
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">case</span> KVM_EXIT_MMIO: {
</span></span><span style="display:flex;"><span>			<span style="color:#00688b;font-weight:bold">bool</span> ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">			 * If we had MMIO exit, coalesced ring should be processed
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">			 * *before* processing the exit itself
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">			 */</span>
</span></span><span style="display:flex;"><span>			<span style="color:#008b45">kvm_cpu__handle_coalesced_mmio</span>(cpu);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			ret = <span style="color:#008b45">kvm_cpu__emulate_mmio</span>(cpu,
</span></span><span style="display:flex;"><span>						    cpu-&gt;kvm_run-&gt;mmio.phys_addr,
</span></span><span style="display:flex;"><span>						    cpu-&gt;kvm_run-&gt;mmio.data,
</span></span><span style="display:flex;"><span>						    cpu-&gt;kvm_run-&gt;mmio.len,
</span></span><span style="display:flex;"><span>						    cpu-&gt;kvm_run-&gt;mmio.is_write);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">if</span> (!ret)
</span></span><span style="display:flex;"><span>				<span style="color:#8b008b;font-weight:bold">goto</span> panic_kvm;
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">case</span> KVM_EXIT_INTR:
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">if</span> (cpu-&gt;is_running)
</span></span><span style="display:flex;"><span>				<span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">goto</span> exit_kvm;
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">case</span> KVM_EXIT_SHUTDOWN:
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">goto</span> exit_kvm;
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">case</span> KVM_EXIT_SYSTEM_EVENT:
</span></span><span style="display:flex;"><span>			<span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">			 * Print the type of system event and
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">			 * treat all system events as shutdown request.
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">			 */</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">switch</span> (cpu-&gt;kvm_run-&gt;system_event.type) {
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">default</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#008b45">pr_warning</span>(<span style="color:#cd5555">&#34;unknown system event type %d&#34;</span>,
</span></span><span style="display:flex;"><span>					   cpu-&gt;kvm_run-&gt;system_event.type);
</span></span><span style="display:flex;"><span>				<span style="color:#228b22">/* fall through for now */</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">case</span> KVM_SYSTEM_EVENT_RESET:
</span></span><span style="display:flex;"><span>				<span style="color:#228b22">/* Fall through for now */</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">case</span> KVM_SYSTEM_EVENT_SHUTDOWN:
</span></span><span style="display:flex;"><span>				<span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">				 * Ensure that all VCPUs are torn down,
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">				 * regardless of which CPU generated the event.
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">				 */</span>
</span></span><span style="display:flex;"><span>				<span style="color:#008b45">kvm__reboot</span>(cpu-&gt;kvm);
</span></span><span style="display:flex;"><span>				<span style="color:#8b008b;font-weight:bold">goto</span> exit_kvm;
</span></span><span style="display:flex;"><span>			};
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">default</span>: {
</span></span><span style="display:flex;"><span>			<span style="color:#00688b;font-weight:bold">bool</span> ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			ret = <span style="color:#008b45">kvm_cpu__handle_exit</span>(cpu);
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">if</span> (!ret)
</span></span><span style="display:flex;"><span>				<span style="color:#8b008b;font-weight:bold">goto</span> panic_kvm;
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">kvm_cpu__handle_coalesced_mmio</span>(cpu);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exit_kvm:
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>panic_kvm:
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰§è¡Œ<code>ioctl(vcpu-&gt;vcpu_fd, KVM_RUN, 0)</code>è¿›å…¥<code>kvm</code>çš„æµç¨‹å¦‚ä¸‹:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#008b45">kvm_arch_vcpu_ioctl_run</span>(vcpu);-&gt;
</span></span><span style="display:flex;"><span>    <span style="color:#008b45">vcpu_run</span>(vcpu);-&gt;
</span></span><span style="display:flex;"><span>    	<span style="color:#008b45">vcpu_enter_guest</span>(vcpu);-&gt;
</span></span><span style="display:flex;"><span>    		<span style="color:#008b45">static_call</span>(kvm_x86_run)(vcpu);-&gt;
</span></span><span style="display:flex;"><span>    			<span style="color:#008b45">vmx_vcpu_run</span>(vcpu);-&gt;
</span></span><span style="display:flex;"><span>    				<span style="color:#008b45">vmx_vcpu_enter_exit</span>(vcpu, vmx);-&gt;
</span></span><span style="display:flex;"><span>						<span style="color:#008b45">__vmx_vcpu_run</span>(vmx, (<span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">long</span> *)&amp;vcpu-&gt;arch.regs, vmx-&gt;loaded_vmcs-&gt;launched)(arch/x86/kvm/vmx/vmenter.S);-&gt;
</span></span><span style="display:flex;"><span>    						vmx_vmenter
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ€ç»ˆè°ƒç”¨<code>__vmx_vcpu_run</code>å‡½æ•°è¿›å…¥<code>vCPU</code>è¿è¡Œçš„çœŸæ­£å…¥å£ï¼Œå…¶ä¸­<code>(unsigned long *)&amp;vcpu-&gt;arch.regs</code>æ˜¯ç”±<code>kvm</code>ä¿å­˜<code>vCPU</code>çš„é€šç”¨å¯„å­˜å™¨ã€‚</p>
<blockquote>
<p><code>System V AMD64 ABI</code> å‰å…­ä¸ªæ•´å‹æˆ–æŒ‡é’ˆå‚æ•°ä¾æ¬¡ä½¿ç”¨å¯„å­˜å™¨ <code>rdi, rsi, rdx, rcx, r8, r9</code>ã€‚</p>
</blockquote>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * __vmx_vcpu_run - Run a vCPU via a transition to VMX guest mode
</span></span><span style="display:flex;"><span> * @vmx:	struct vcpu_vmx * (forwarded to vmx_update_host_rsp)
</span></span><span style="display:flex;"><span> * @regs:	unsigned long * (to guest registers)
</span></span><span style="display:flex;"><span> * @launched:	%true if the VMCS has been launched
</span></span><span style="display:flex;"><span> *
</span></span><span style="display:flex;"><span> * Returns:
</span></span><span style="display:flex;"><span> *	0 on VM-Exit, 1 on VM-Fail
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>SYM_FUNC_START(__vmx_vcpu_run)
</span></span><span style="display:flex;"><span>	push %_ASM_BP
</span></span><span style="display:flex;"><span>	mov  %_ASM_SP, %_ASM_BP
</span></span><span style="display:flex;"><span>#ifdef CONFIG_X86_64
</span></span><span style="display:flex;"><span>	push %r15
</span></span><span style="display:flex;"><span>	push %r14
</span></span><span style="display:flex;"><span>	push %r13
</span></span><span style="display:flex;"><span>	push %r12
</span></span><span style="display:flex;"><span>#else
</span></span><span style="display:flex;"><span>	push %edi
</span></span><span style="display:flex;"><span>	push %esi
</span></span><span style="display:flex;"><span>#endif
</span></span><span style="display:flex;"><span>	push %_ASM_BX
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/*
</span></span><span style="display:flex;"><span>	 * Save @regs, _ASM_ARG2 may be modified by vmx_update_host_rsp() and
</span></span><span style="display:flex;"><span>	 * @regs is needed after VM-Exit to save the guest&#39;s register values.
</span></span><span style="display:flex;"><span>	 */
</span></span><span style="display:flex;"><span>	push %_ASM_ARG2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/* Copy @launched to BL, _ASM_ARG3 is volatile. */
</span></span><span style="display:flex;"><span>	mov %_ASM_ARG3B, %bl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/* Adjust RSP to account for the CALL to vmx_vmenter(). */
</span></span><span style="display:flex;"><span>	lea -WORD_SIZE(%_ASM_SP), %_ASM_ARG2
</span></span><span style="display:flex;"><span>	call vmx_update_host_rsp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/* Load @regs to RAX. */
</span></span><span style="display:flex;"><span>	mov (%_ASM_SP), %_ASM_AX
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/* Check if vmlaunch or vmresume is needed */
</span></span><span style="display:flex;"><span>	testb %bl, %bl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/* Load guest registers.  Don&#39;t clobber flags. */
</span></span><span style="display:flex;"><span>	mov VCPU_RCX(%_ASM_AX), %_ASM_CX
</span></span><span style="display:flex;"><span>	mov VCPU_RDX(%_ASM_AX), %_ASM_DX
</span></span><span style="display:flex;"><span>	mov VCPU_RBX(%_ASM_AX), %_ASM_BX
</span></span><span style="display:flex;"><span>	mov VCPU_RBP(%_ASM_AX), %_ASM_BP
</span></span><span style="display:flex;"><span>	mov VCPU_RSI(%_ASM_AX), %_ASM_SI
</span></span><span style="display:flex;"><span>	mov VCPU_RDI(%_ASM_AX), %_ASM_DI
</span></span><span style="display:flex;"><span>#ifdef CONFIG_X86_64
</span></span><span style="display:flex;"><span>	mov VCPU_R8 (%_ASM_AX),  %r8
</span></span><span style="display:flex;"><span>	mov VCPU_R9 (%_ASM_AX),  %r9
</span></span><span style="display:flex;"><span>	mov VCPU_R10(%_ASM_AX), %r10
</span></span><span style="display:flex;"><span>	mov VCPU_R11(%_ASM_AX), %r11
</span></span><span style="display:flex;"><span>	mov VCPU_R12(%_ASM_AX), %r12
</span></span><span style="display:flex;"><span>	mov VCPU_R13(%_ASM_AX), %r13
</span></span><span style="display:flex;"><span>	mov VCPU_R14(%_ASM_AX), %r14
</span></span><span style="display:flex;"><span>	mov VCPU_R15(%_ASM_AX), %r15
</span></span><span style="display:flex;"><span>#endif
</span></span><span style="display:flex;"><span>	/* Load guest RAX.  This kills the @regs pointer! */
</span></span><span style="display:flex;"><span>	mov VCPU_RAX(%_ASM_AX), %_ASM_AX
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/* Enter guest mode */
</span></span><span style="display:flex;"><span>	call vmx_vmenter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/* Jump on VM-Fail. */
</span></span><span style="display:flex;"><span>	jbe 2f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/* Temporarily save guest&#39;s RAX. */
</span></span><span style="display:flex;"><span>	push %_ASM_AX
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/* Reload @regs to RAX. */
</span></span><span style="display:flex;"><span>	mov WORD_SIZE(%_ASM_SP), %_ASM_AX
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/* Save all guest registers, including RAX from the stack */
</span></span><span style="display:flex;"><span>	pop           VCPU_RAX(%_ASM_AX)
</span></span><span style="display:flex;"><span>	mov %_ASM_CX, VCPU_RCX(%_ASM_AX)
</span></span><span style="display:flex;"><span>	mov %_ASM_DX, VCPU_RDX(%_ASM_AX)
</span></span><span style="display:flex;"><span>	mov %_ASM_BX, VCPU_RBX(%_ASM_AX)
</span></span><span style="display:flex;"><span>	mov %_ASM_BP, VCPU_RBP(%_ASM_AX)
</span></span><span style="display:flex;"><span>	mov %_ASM_SI, VCPU_RSI(%_ASM_AX)
</span></span><span style="display:flex;"><span>	mov %_ASM_DI, VCPU_RDI(%_ASM_AX)
</span></span><span style="display:flex;"><span>#ifdef CONFIG_X86_64
</span></span><span style="display:flex;"><span>	mov %r8,  VCPU_R8 (%_ASM_AX)
</span></span><span style="display:flex;"><span>	mov %r9,  VCPU_R9 (%_ASM_AX)
</span></span><span style="display:flex;"><span>	mov %r10, VCPU_R10(%_ASM_AX)
</span></span><span style="display:flex;"><span>	mov %r11, VCPU_R11(%_ASM_AX)
</span></span><span style="display:flex;"><span>	mov %r12, VCPU_R12(%_ASM_AX)
</span></span><span style="display:flex;"><span>	mov %r13, VCPU_R13(%_ASM_AX)
</span></span><span style="display:flex;"><span>	mov %r14, VCPU_R14(%_ASM_AX)
</span></span><span style="display:flex;"><span>	mov %r15, VCPU_R15(%_ASM_AX)
</span></span><span style="display:flex;"><span>#endif
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/* Clear RAX to indicate VM-Exit (as opposed to VM-Fail). */
</span></span><span style="display:flex;"><span>	xor %eax, %eax
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/*
</span></span><span style="display:flex;"><span>	 * Clear all general purpose registers except RSP and RAX to prevent
</span></span><span style="display:flex;"><span>	 * speculative use of the guest&#39;s values, even those that are reloaded
</span></span><span style="display:flex;"><span>	 * via the stack.  In theory, an L1 cache miss when restoring registers
</span></span><span style="display:flex;"><span>	 * could lead to speculative execution with the guest&#39;s values.
</span></span><span style="display:flex;"><span>	 * Zeroing XORs are dirt cheap, i.e. the extra paranoia is essentially
</span></span><span style="display:flex;"><span>	 * free.  RSP and RAX are exempt as RSP is restored by hardware during
</span></span><span style="display:flex;"><span>	 * VM-Exit and RAX is explicitly loaded with 0 or 1 to return VM-Fail.
</span></span><span style="display:flex;"><span>	 */
</span></span><span style="display:flex;"><span>1:	xor %ecx, %ecx
</span></span><span style="display:flex;"><span>	xor %edx, %edx
</span></span><span style="display:flex;"><span>	xor %ebx, %ebx
</span></span><span style="display:flex;"><span>	xor %ebp, %ebp
</span></span><span style="display:flex;"><span>	xor %esi, %esi
</span></span><span style="display:flex;"><span>	xor %edi, %edi
</span></span><span style="display:flex;"><span>#ifdef CONFIG_X86_64
</span></span><span style="display:flex;"><span>	xor %r8d,  %r8d
</span></span><span style="display:flex;"><span>	xor %r9d,  %r9d
</span></span><span style="display:flex;"><span>	xor %r10d, %r10d
</span></span><span style="display:flex;"><span>	xor %r11d, %r11d
</span></span><span style="display:flex;"><span>	xor %r12d, %r12d
</span></span><span style="display:flex;"><span>	xor %r13d, %r13d
</span></span><span style="display:flex;"><span>	xor %r14d, %r14d
</span></span><span style="display:flex;"><span>	xor %r15d, %r15d
</span></span><span style="display:flex;"><span>#endif
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/* &#34;POP&#34; @regs. */
</span></span><span style="display:flex;"><span>	add $WORD_SIZE, %_ASM_SP
</span></span><span style="display:flex;"><span>	pop %_ASM_BX
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#ifdef CONFIG_X86_64
</span></span><span style="display:flex;"><span>	pop %r12
</span></span><span style="display:flex;"><span>	pop %r13
</span></span><span style="display:flex;"><span>	pop %r14
</span></span><span style="display:flex;"><span>	pop %r15
</span></span><span style="display:flex;"><span>#else
</span></span><span style="display:flex;"><span>	pop %esi
</span></span><span style="display:flex;"><span>	pop %edi
</span></span><span style="display:flex;"><span>#endif
</span></span><span style="display:flex;"><span>	pop %_ASM_BP
</span></span><span style="display:flex;"><span>	RET
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/* VM-Fail.  Out-of-line to avoid a taken Jcc after VM-Exit. */
</span></span><span style="display:flex;"><span>2:	mov $1, %eax
</span></span><span style="display:flex;"><span>	jmp 1b
</span></span><span style="display:flex;"><span>SYM_FUNC_END(__vmx_vcpu_run)
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°æ±‡ç¼–ä»£ç çš„åŠŸèƒ½:</p>
<ul>
<li>å°†<code>host</code>çš„æŸäº›é€šç”¨å¯„å­˜å™¨å…¥æ ˆä¿å­˜ã€‚</li>
<li>ä»<code>vcpu-&gt;arch.regs</code>æ•°ç»„ä¸­åŠ è½½å¯¹åº”çš„<code>vcpu</code>å¯„å­˜å™¨å€¼åˆ°å¯¹åº”å¯„å­˜å™¨ä¸­ã€‚</li>
<li>æ ¹æ®<code>vmx-&gt;loaded_vmcs-&gt;launched</code>çš„å€¼ï¼Œå†³å®šåœ¨<code>VM-Entry</code>æ—¶æ˜¯ä½¿ç”¨<code>vmlaunch</code>è¿˜æ˜¯<code>vmresume</code>ï¼ŒåŒºåˆ«åœ¨äºæ˜¯å¦åœ¨åŒä¸€é€»è¾‘<code>cpu</code>ä¸Šè¿è¡Œã€‚</li>
</ul>
<p>åœ¨æ‰§è¡Œ<code>call vmx_vmenter</code>çš„æ—¶å€™ä¼šå°†å½“å‰<code>host rip(jbe 2f)</code>å‹æ ˆï¼Œåœ¨<code>vmx_vmenter</code>ä¸­ä¼šä½¿å¾—å½“å‰é€»è¾‘<code>cpu</code>è¿›å…¥<code>VMX Non-Root Operation</code>ã€‚</p>
<p><code>vmx_vmenter</code>ä¸­æ ¹æ®<code>RFLAGS.ZF</code>çš„å€¼æ¥å†³å®šä½¿ç”¨<code>vmlaunch</code>è¿˜æ˜¯<code>vmresume</code>:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * vmx_vmenter - VM-Enter the current loaded VMCS
</span></span><span style="display:flex;"><span> *
</span></span><span style="display:flex;"><span> * %RFLAGS.ZF:	!VMCS.LAUNCHED, i.e. controls VMLAUNCH vs. VMRESUME
</span></span><span style="display:flex;"><span> *
</span></span><span style="display:flex;"><span> * Returns:
</span></span><span style="display:flex;"><span> *	%RFLAGS.CF is set on VM-Fail Invalid
</span></span><span style="display:flex;"><span> *	%RFLAGS.ZF is set on VM-Fail Valid
</span></span><span style="display:flex;"><span> *	%RFLAGS.{CF,ZF} are cleared on VM-Success, i.e. VM-Exit
</span></span><span style="display:flex;"><span> *
</span></span><span style="display:flex;"><span> * Note that VMRESUME/VMLAUNCH fall-through and return directly if
</span></span><span style="display:flex;"><span> * they VM-Fail, whereas a successful VM-Enter + VM-Exit will jump
</span></span><span style="display:flex;"><span> * to vmx_vmexit.
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>SYM_FUNC_START_LOCAL(vmx_vmenter)
</span></span><span style="display:flex;"><span>	/* EFLAGS.ZF is set if VMCS.LAUNCHED == 0 */
</span></span><span style="display:flex;"><span>	je 2f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>1:	vmresume
</span></span><span style="display:flex;"><span>	RET
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2:	vmlaunch
</span></span><span style="display:flex;"><span>	RET
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>3:	cmpb $0, kvm_rebooting
</span></span><span style="display:flex;"><span>	je 4f
</span></span><span style="display:flex;"><span>	RET
</span></span><span style="display:flex;"><span>4:	ud2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	_ASM_EXTABLE(1b, 3b)
</span></span><span style="display:flex;"><span>	_ASM_EXTABLE(2b, 3b)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SYM_FUNC_END(vmx_vmenter)
</span></span></code></pre></td></tr></table>
</div>
</div><p>å½“é€»è¾‘<code>cpu</code>å‘ç”Ÿ<code>VM-Exit</code>ä¹Ÿå³åˆ‡æ¢åˆ°<code>VMX Root Operation</code>æ—¶ä¼šåŠ è½½<code>vmcs host state area</code>ä¸­çš„<code>rip</code>ï¼Œæ­¤æ—¶æ§åˆ¶æµä¼šåˆ‡åˆ°<code>vmx_vmexit</code>ï¼Œè¿™æ˜¯å› ä¸º<code>vmcs</code>ä¸­çš„<code>host rip</code>è¢«è®¾ç½®åˆ°æ­¤å¤„:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * Set up the vmcs&#39;s constant host-state fields, i.e., host-state fields that
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * will not change in the lifetime of the guest.
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * Note that host-state that does change is set elsewhere. E.g., host-state
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * that is set differently for each CPU is set in vmx_vcpu_load(), not here.
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">vmx_set_constant_host_state</span>(<span style="color:#8b008b;font-weight:bold">struct</span> vcpu_vmx *vmx)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ...;
</span></span><span style="display:flex;"><span>    <span style="color:#008b45">vmcs_writel</span>(HOST_RIP, (<span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">long</span>)vmx_vmexit);
</span></span><span style="display:flex;"><span>    ...;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚ä¸‹ä¸º<code>vmx_vmexit</code>çš„å®ç°:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// arch/x86/kvm/vmx/vmenter.S
</span></span><span style="display:flex;"><span>SYM_FUNC_START(vmx_vmexit)
</span></span><span style="display:flex;"><span>#ifdef CONFIG_RETPOLINE
</span></span><span style="display:flex;"><span>    ALTERNATIVE &#34;jmp .Lvmexit_skip_rsb&#34;, &#34;&#34;, X86_FEATURE_RETPOLINE
</span></span><span style="display:flex;"><span>    /* Preserve guest&#39;s RAX, it&#39;s used to stuff the RSB. */
</span></span><span style="display:flex;"><span>    push %_ASM_AX
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    /* IMPORTANT: Stuff the RSB immediately after VM-Exit, before RET! */
</span></span><span style="display:flex;"><span>    FILL_RETURN_BUFFER %_ASM_AX, RSB_CLEAR_LOOPS, X86_FEATURE_RETPOLINE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    /* Clear RFLAGS.CF and RFLAGS.ZF to preserve VM-Exit, i.e. !VM-Fail. */
</span></span><span style="display:flex;"><span>    or $1, %_ASM_AX
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pop %_ASM_AX
</span></span><span style="display:flex;"><span>.Lvmexit_skip_rsb:
</span></span><span style="display:flex;"><span>#endif
</span></span><span style="display:flex;"><span>    ret
</span></span><span style="display:flex;"><span>SYM_FUNC_END(vmx_vmexit)
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œè¦åšçš„å°±æ˜¯åœ¨<code>VM-Exit</code>åçš„ç¬¬ä¸€æ—¶é—´å¡«å……è¦†ç›–<code>RSB</code>ï¼Œé˜²å¾¡å¯¹<code>VM  Spectre-type</code>æ”»å‡»ã€‚ä¹‹åæ‰§è¡Œ<code>ret</code>è¿”å›åˆ°<code>__vmx_vcpu_run</code>ä¸­ç»§ç»­æ‰§è¡Œã€‚ç”±äº<code>ret</code>æŒ‡ä»¤ä¼šæ‰§è¡Œ<code>pop rip</code>è®©<code>rip</code>æŒ‡å‘è°ƒç”¨<code>vmx_vmexit</code>æ—¶çš„åä¸€æ¡æŒ‡ä»¤ï¼Œå…¶å®å°±æ˜¯æ‰§è¡Œ<code>jbe 2f</code>ã€‚æŒ‡ä»¤<code>jbe 2f</code>æ ¹æ®<code>RFLAGS.{CF,ZF}</code>çš„å€¼æ¥å†³å®šæ˜¯å¦è·³è½¬ã€‚æœ€å<code>__vmx_vcpu_run</code>ç»§ç»­æ‰§è¡Œä¿å­˜<code>vCPU</code>å¯„å­˜å™¨çš„å€¼ï¼Œæ¢å¤é€»è¾‘<code>cpu</code>çš„çŠ¶æ€ã€‚</p>
<p>å½“<code>vmx_vcpu_enter_exit</code>è¿”å›åˆ°<code>vmx_vcpu_run</code>åï¼Œä¼šè°ƒç”¨<code>vmcs_read32</code>è¯»å‡ºä»<code>current-vmcs</code>ä¸­è¯»å‡º<code>VM-Exit</code>çš„åŸå› :</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>vmx-&gt;exit_reason.full = <span style="color:#008b45">vmcs_read32</span>(VM_EXIT_REASON);
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¥ä¸‹æ¥<code>vmx_vcpu_run</code>å‡½æ•°å°†<code>loaded_vmcs</code>è®¾ç½®ä¸º<code>true</code>å¹¶ä¸”æ£€æŸ¥èƒ½å¦åœ¨<code>kvm</code>ä¸­å¿«é€Ÿå¤„ç†æœ¬æ¬¡<code>VM-Exit</code>:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>vmx-&gt;loaded_vmcs-&gt;launched = <span style="color:#b452cd">1</span>;
</span></span><span style="display:flex;"><span>...;
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#008b45">vmx_exit_handlers_fastpath</span>(vcpu);
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">fastpath_t</span> <span style="color:#008b45">vmx_exit_handlers_fastpath</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vcpu *vcpu)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">switch</span> (<span style="color:#008b45">to_vmx</span>(vcpu)-&gt;exit_reason.basic) {
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">case</span> EXIT_REASON_MSR_WRITE:
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#008b45">handle_fastpath_set_msr_irqoff</span>(vcpu);
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">case</span> EXIT_REASON_PREEMPTION_TIMER:
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#008b45">handle_fastpath_preemption_timer</span>(vcpu);
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">default</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">return</span> EXIT_FASTPATH_NONE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»<code>vmx_vcpu_run</code>è¿”å›<code>vcpu_enter_guest</code>åï¼Œé€šè¿‡<code>vmx_handle_exit</code>æ ¹æ®<code>vmx-&gt;exit_reason.full</code>è°ƒç”¨å…¨å±€æ•°ç»„<code>kvm_vmx_exit_handlers</code>å¯¹åº”çš„<code>VM-Exit</code>å‡½æ•°:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * The exit handlers return 1 if the exit was handled fully and guest execution
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * may resume.  Otherwise they set the kvm_run parameter to indicate what needs
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * to be done to userspace and return 0.
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#008b45">int</span> (*kvm_vmx_exit_handlers[])(<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vcpu *vcpu) = {
</span></span><span style="display:flex;"><span>	[EXIT_REASON_EXCEPTION_NMI]           = handle_exception_nmi,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_EXTERNAL_INTERRUPT]      = handle_external_interrupt,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_TRIPLE_FAULT]            = handle_triple_fault,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_NMI_WINDOW]	      = handle_nmi_window,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_IO_INSTRUCTION]          = handle_io,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_CR_ACCESS]               = handle_cr,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_DR_ACCESS]               = handle_dr,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_CPUID]                   = kvm_emulate_cpuid,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_MSR_READ]                = kvm_emulate_rdmsr,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_MSR_WRITE]               = kvm_emulate_wrmsr,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_INTERRUPT_WINDOW]        = handle_interrupt_window,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_HLT]                     = kvm_emulate_halt,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_INVD]		      = kvm_emulate_invd,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_INVLPG]		      = handle_invlpg,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_RDPMC]                   = kvm_emulate_rdpmc,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_VMCALL]                  = kvm_emulate_hypercall,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_VMCLEAR]		      = handle_vmx_instruction,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_VMLAUNCH]		      = handle_vmx_instruction,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_VMPTRLD]		      = handle_vmx_instruction,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_VMPTRST]		      = handle_vmx_instruction,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_VMREAD]		      = handle_vmx_instruction,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_VMRESUME]		      = handle_vmx_instruction,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_VMWRITE]		      = handle_vmx_instruction,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_VMOFF]		      = handle_vmx_instruction,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_VMON]		      = handle_vmx_instruction,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_TPR_BELOW_THRESHOLD]     = handle_tpr_below_threshold,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_APIC_ACCESS]             = handle_apic_access,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_APIC_WRITE]              = handle_apic_write,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_EOI_INDUCED]             = handle_apic_eoi_induced,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_WBINVD]                  = kvm_emulate_wbinvd,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_XSETBV]                  = kvm_emulate_xsetbv,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_TASK_SWITCH]             = handle_task_switch,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_MCE_DURING_VMENTRY]      = handle_machine_check,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_GDTR_IDTR]		      = handle_desc,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_LDTR_TR]		      = handle_desc,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_EPT_VIOLATION]	      = handle_ept_violation,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_EPT_MISCONFIG]           = handle_ept_misconfig,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_PAUSE_INSTRUCTION]       = handle_pause,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_MWAIT_INSTRUCTION]	      = kvm_emulate_mwait,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_MONITOR_TRAP_FLAG]       = handle_monitor_trap,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_MONITOR_INSTRUCTION]     = kvm_emulate_monitor,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_INVEPT]                  = handle_vmx_instruction,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_INVVPID]                 = handle_vmx_instruction,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_RDRAND]                  = kvm_handle_invalid_op,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_RDSEED]                  = kvm_handle_invalid_op,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_PML_FULL]		      = handle_pml_full,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_INVPCID]                 = handle_invpcid,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_VMFUNC]		      = handle_vmx_instruction,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_PREEMPTION_TIMER]	      = handle_preemption_timer,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_ENCLS]		      = handle_encls,
</span></span><span style="display:flex;"><span>	[EXIT_REASON_BUS_LOCK]                = handle_bus_lock_vmexit,
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹äºä¸Šè¿°<code>VM-Exit</code>äº‹ä»¶æ¥è¯´ï¼Œæœ‰çš„<code>kvm</code>èƒ½å¤Ÿè‡ªå·±å¤„ç†ï¼Œæ­¤æ—¶ç”±<code>kvm</code>å¤„ç†åç›´æ¥è¿”å›ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡ <code>VM-Entry</code>ï¼›å¦‚æœ<code>kvm</code>æ— æ³•å¤„ç†ï¼Œæ¯”å¦‚ç”±äº<code>IO</code>æŒ‡ä»¤è§¦å‘çš„<code>EXIT_REASON_IO_INSTRUCTION</code>ï¼Œåˆ™éœ€è¦è¿”å›åˆ°<code>kvmtool</code>ä¸­è¿›è¡Œå¤„ç†:</p>
<p><strong><code>handle_io</code></strong>:æ­¤å‡½æ•°å¤„ç†çš„å¯¹åº”äº‹ä»¶æ˜¯<code>EXIT_REASON_IO_INSTRUCTION</code>ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°<code>emulator_pio_in_out</code>:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">int</span> <span style="color:#008b45">emulator_pio_in_out</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vcpu *vcpu, <span style="color:#00688b;font-weight:bold">int</span> size,
</span></span><span style="display:flex;"><span>			       <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">short</span> port,
</span></span><span style="display:flex;"><span>			       <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> count, <span style="color:#00688b;font-weight:bold">bool</span> in)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	vcpu-&gt;arch.pio.port = port;
</span></span><span style="display:flex;"><span>	vcpu-&gt;arch.pio.in = in;
</span></span><span style="display:flex;"><span>	vcpu-&gt;arch.pio.count  = count;
</span></span><span style="display:flex;"><span>	vcpu-&gt;arch.pio.size = size;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (!<span style="color:#008b45">kernel_pio</span>(vcpu, vcpu-&gt;arch.pio_data))
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	vcpu-&gt;run-&gt;exit_reason = KVM_EXIT_IO;
</span></span><span style="display:flex;"><span>	vcpu-&gt;run-&gt;io.direction = in ? KVM_EXIT_IO_IN : KVM_EXIT_IO_OUT;
</span></span><span style="display:flex;"><span>	vcpu-&gt;run-&gt;io.size = size;
</span></span><span style="display:flex;"><span>	vcpu-&gt;run-&gt;io.data_offset = KVM_PIO_PAGE_OFFSET * PAGE_SIZE;
</span></span><span style="display:flex;"><span>	vcpu-&gt;run-&gt;io.count = count;
</span></span><span style="display:flex;"><span>	vcpu-&gt;run-&gt;io.port = port;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°<code>emulator_pio_in_out</code>å‡½æ•°ä¸­ä¼šè®¾ç½®<code>vcpu-&gt;run-&gt;exit_reason</code>ä¸º<code>KVM_EXIT_IO</code>å¹¶ä¸”æœ€ç»ˆè¿”å›<code>0</code>ï¼Œè¿™å°†å¯¼è‡´<code>vcpu_run</code>é€€å‡ºå¾ªç¯å¹¶è¿”å›åˆ°<code>kvmtool</code>ä¸­è¿›è¡Œå¤„ç†:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">int</span> <span style="color:#008b45">vcpu_run</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vcpu *vcpu)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ...;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">for</span> (;;) {
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">if</span> (<span style="color:#008b45">kvm_vcpu_running</span>(vcpu)) {
</span></span><span style="display:flex;"><span>			r = <span style="color:#008b45">vcpu_enter_guest</span>(vcpu);
</span></span><span style="display:flex;"><span>		} <span style="color:#8b008b;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>			r = <span style="color:#008b45">vcpu_block</span>(kvm, vcpu);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">//å¦‚æœvcpu_enter_guestè¿”å›å€¼å°äºç­‰äº0ç›´æ¥è·³å‡ºå¾ªç¯è¿”å›åˆ°kvmtool
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        <span style="color:#8b008b;font-weight:bold">if</span> (r &lt;= <span style="color:#b452cd">0</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>        ...;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">//è¿”å›åˆ°ç”¨æˆ·æ€kvmtoolä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">return</span> r;
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ­¤æ—¶<code>kvmtool</code>åœ¨å‡½æ•°<code>kvm_cpu__start</code>ä¸­æ ¹æ®<code>cpu-&gt;kvm_run-&gt;exit_reason</code>è¿›è¡Œå¤„ç†ã€‚<code>kvm_cpu__start</code>å‡½æ•°çš„å®šä¹‰è¯·å‚è§å‰é¢çš„å†…å®¹ã€‚</p>
<h2 id="vcpuçš„è°ƒåº¦"><code>vCPU</code>çš„è°ƒåº¦</h2>
<p><code>vCPU</code>åœ¨ä¸åŒçš„é€»è¾‘<code>cpu</code>ä¸Šè¿è¡Œæ—¶ä¼šå½±å“è™šæ‹Ÿæœºçš„æ€§èƒ½ã€‚è¿™æ˜¯å› ä¸ºåœ¨åŒä¸€ä¸ªé€»è¾‘<code>cpu</code>ä¸Šè°ƒåº¦<code>vCPU</code>æ—¶ï¼Œåªéœ€è¦æ‰§è¡Œä¸€æ¬¡<code>vmlaunch</code>æŒ‡ä»¤ï¼Œåç»­æ¯æ¬¡<code>VM-Entry</code>åˆ™åªæ‰§è¡Œ<code>vmresume</code>æŒ‡ä»¤ï¼›å¦‚æœ<code>vCPU</code>åœ¨ä¸åŒçš„é€»è¾‘<code>cpu</code>ä¹‹é—´æ¥å›åˆ‡æ¢ï¼Œåˆ™åˆ‡æ¢ä¸€æ¬¡éœ€è¦æ‰§è¡Œ<code>vmclear,vmptrld,vmlaunch</code>ä¸‰ä¸ªæŒ‡ä»¤ã€‚</p>
<p>è™šæ‹Ÿæœºçš„æ¯ä¸€ä¸ª<code>vCPU</code>å¯¹åº”<code>kvmtool</code>ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œé€šè¿‡å®¿ä¸»æœºå†…æ ¸è°ƒåº¦å™¨è¿›è¡Œç»Ÿä¸€è°ƒåº¦ç®¡ç†ã€‚è‹¥æ²¡æœ‰å°†è™šæ‹Ÿæœºçš„<code>vCPU</code>çº¿ç¨‹ç»‘å®šåˆ°é€»è¾‘<code>cpu</code>ä¸Šï¼Œé‚£ä¹ˆ<code>vCPU</code>çº¿ç¨‹å¯èƒ½åœ¨æ¯æ¬¡è¿è¡Œæ—¶è¢«è°ƒåº¦åˆ°ä¸åŒçš„é€»è¾‘<code>cpu</code>ä¸Šã€‚</p>
<p>å¦‚ä¸‹ä¸ºå°†<code>vCPU</code>è°ƒåº¦åˆ°ä¸åŒé€»è¾‘<code>cpu</code>çš„åŸºæœ¬æ­¥éª¤:</p>
<ul>
<li>åœ¨æºé€»è¾‘<code>cpu</code>ä¸Šæ‰§è¡Œ<code>vmclear</code>æŒ‡ä»¤ï¼Œå°†å½“å‰é€»è¾‘<code>cpu</code>å…³è”çš„<code>vmcs</code>æŸäº›æ•°æ®å¤åˆ¶åˆ°<code>vmcs region</code>æ‰€åœ¨çš„å†…å­˜ä¸­ï¼Œå¹¶ä¸”è®¾ç½®<code>vmcs</code>çš„<code>launch state</code>ä¸º<code>clear</code>ã€‚</li>
<li>åœ¨ç›®çš„é€»è¾‘<code>cpu</code>ä»¥<code>vCPU</code>çš„<code>vmcs</code>ç‰©ç†åœ°å€ä¸ºæ“ä½œæ•°æ‰§è¡Œ<code>vmptrld</code>æŒ‡ä»¤ã€‚</li>
<li>åœ¨ç›®çš„é€»è¾‘<code>cpu</code>ä¸Šæ‰§è¡Œ<code>vmlaunch</code>æŒ‡ä»¤ã€‚</li>
</ul>
<p>å¯¹äº<code>kvm</code>æ¥è¯´ï¼Œé¦–å…ˆæ¯ä¸ªé€»è¾‘<code>cpu</code>æœ‰ä¸€ä¸ªæŒ‡å‘<code>vmcs</code>ç»“æ„ä½“çš„æŒ‡é’ˆ<code>per_cpu</code>å˜é‡<code>current_vmcs</code>:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#008b45">DECLARE_PER_CPU</span>(<span style="color:#8b008b;font-weight:bold">struct</span> vmcs *, current_vmcs); <span style="color:#228b22">// arch/x86/kvm/vmx/vmcs.h
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#008b45">DEFINE_PER_CPU</span>(<span style="color:#8b008b;font-weight:bold">struct</span> vmcs *, current_vmcs);  <span style="color:#228b22">// arch/x86/kvm/vmx/vmx.c
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æ¯ä¸€ä¸ª<code>vCPU</code>ä¹Ÿä¼šåˆ†é…<code>vmcs</code>ç»“æ„ï¼Œè¿™æ˜¯<code>vmx_create_vcpu</code>è°ƒç”¨<code>alloc_loaded_vmcs</code>åˆ†é…å¹¶ä¿å­˜åœ¨<code>vmx-&gt;loaded_vmcs-&gt;vmcs</code>æˆå‘˜ä¸­ã€‚<code>vCPU</code>çš„è°ƒåº¦çš„æœ¬è´¨å°±æ˜¯é€»è¾‘<code>cpu</code>çš„<code>current_vmcs</code>åœ¨æŸä¸€æ—¶åˆ»æŒ‡å‘<code>vCPU</code>çš„<code>vmcs</code>ã€‚</p>
<p><code>vcpu_load</code>å’Œ<code>vcpu_put</code>æ˜¯å®ç°<code>vCPU</code>è°ƒåº¦çš„å…³é”®ã€‚</p>
<h3 id="vcpu_load"><code>vcpu_load</code></h3>
<p><code>vcpu_load</code>å‡½æ•°å®šä¹‰å¦‚ä¸‹:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * Switches to specified vcpu, until a matching vcpu_put()
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">vcpu_load</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vcpu *vcpu)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">int</span> cpu = <span style="color:#008b45">get_cpu</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">__this_cpu_write</span>(kvm_running_vcpu, vcpu);
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">preempt_notifier_register</span>(&amp;vcpu-&gt;preempt_notifier);
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">kvm_arch_vcpu_load</span>(vcpu, cpu);
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">put_cpu</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#008b45">EXPORT_SYMBOL_GPL</span>(vcpu_load);
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>get_cpu</code>ç¦æ­¢æŠ¢å å¹¶ä¸”è¿”å›å½“å‰é€»è¾‘<code>cpuID</code>ï¼Œ<code>put_cpu</code>å¼€å¯æŠ¢å ã€‚</li>
<li><code>preempt_notifier_register</code>æ³¨å†ŒæŠ¢å å›è°ƒ<code>vcpu-&gt;preempt_notifier</code>ï¼Œè¿™ä¸ªé€šçŸ¥å¯¹è±¡çš„å›è°ƒå‡½æ•°åœ¨åˆ›å»º<code>vCPU</code>æ—¶è°ƒç”¨<code>preempt_notifier_init</code>åˆå§‹åŒ–ä¸º<code>kvm_preempt_ops</code>ã€‚è€Œ<code>kvm_preempt_ops.sched_in</code>å’Œ<code>kvm_preempt_ops.sched_out</code>åœ¨æ‰§è¡Œ<code>kvm_init</code>æ—¶åˆ†åˆ«åˆå§‹åŒ–ä¸º<code>kvm_sched_in</code>å’Œ<code>kvm_sched_out</code>ã€‚å½“<code>vCPU</code>çº¿ç¨‹è¢«æŠ¢å çš„æ—¶å€™ä¼šè°ƒç”¨<code>kvm_sched_out</code>ï¼Œå½“<code>vCPU</code>çº¿ç¨‹æŠ¢å äº†åˆ«çš„çº¿ç¨‹æ—¶ä¼šè°ƒç”¨<code>kvm_sched_in</code>ã€‚</li>
<li><strong><code>kvm_arch_vcpu_load</code>:æœ€ç»ˆè°ƒç”¨<code>vmx_vcpu_load</code>è°ƒåº¦<code>vCPU</code>åˆ°æŒ‡å®šçš„é€»è¾‘<code>cpu</code>ä¸Šï¼Œå…·ä½“çš„é€»è¾‘å‚è§<a class="link" href="#kvm_arch_vcpu_load" ><code>kvm_arch_vcpu_load</code></a>ã€‚</strong></li>
</ul>
<h4 id="kvm_arch_vcpu_load"><code>kvm_arch_vcpu_load</code></h4>
<p><code>kvm_arch_vcpu_load</code>å‡½æ•°æ ¸å¿ƒéƒ¨åˆ†å¦‚ä¸‹</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">kvm_arch_vcpu_load</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vcpu *vcpu, <span style="color:#00688b;font-weight:bold">int</span> cpu)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ...;
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">static_call</span>(kvm_x86_vcpu_load)(vcpu, cpu);
</span></span><span style="display:flex;"><span>    ...;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ¬è´¨å°±æ˜¯è°ƒç”¨<code>vmx_vcpu_load</code>:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * Switches to specified vcpu, until a matching vcpu_put(), but assumes
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * vcpu mutex is already taken.
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">vmx_vcpu_load</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vcpu *vcpu, <span style="color:#00688b;font-weight:bold">int</span> cpu)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> vcpu_vmx *vmx = <span style="color:#008b45">to_vmx</span>(vcpu);
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">vmx_vcpu_load_vmcs</span>(vcpu, cpu, <span style="color:#658b00">NULL</span>);
</span></span><span style="display:flex;"><span>	...;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ€ç»ˆ<code>vcpu</code>è°ƒåº¦çš„å®ç°å…¶å®æ˜¯<code>vmx_vcpu_load_vmcs</code>ï¼š</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">vmx_vcpu_load_vmcs</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vcpu *vcpu, <span style="color:#00688b;font-weight:bold">int</span> cpu,
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">struct</span> loaded_vmcs *buddy)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> vcpu_vmx *vmx = <span style="color:#008b45">to_vmx</span>(vcpu);
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">bool</span> already_loaded = vmx-&gt;loaded_vmcs-&gt;cpu == cpu;
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> vmcs *prev;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (!already_loaded) {
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">loaded_vmcs_clear</span>(vmx-&gt;loaded_vmcs);
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">local_irq_disable</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 * Ensure loaded_vmcs-&gt;cpu is read before adding loaded_vmcs to
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 * this cpu&#39;s percpu list, otherwise it may not yet be deleted
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 * from its previous cpu&#39;s percpu list.  Pairs with the
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 * smb_wmb() in __loaded_vmcs_clear().
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">smp_rmb</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">list_add</span>(&amp;vmx-&gt;loaded_vmcs-&gt;loaded_vmcss_on_cpu_link,
</span></span><span style="display:flex;"><span>			 &amp;<span style="color:#008b45">per_cpu</span>(loaded_vmcss_on_cpu, cpu));
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">local_irq_enable</span>();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	prev = <span style="color:#008b45">per_cpu</span>(current_vmcs, cpu);
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (prev != vmx-&gt;loaded_vmcs-&gt;vmcs) {
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">per_cpu</span>(current_vmcs, cpu) = vmx-&gt;loaded_vmcs-&gt;vmcs;
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">vmcs_load</span>(vmx-&gt;loaded_vmcs-&gt;vmcs);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 * No indirect branch prediction barrier needed when switching
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 * the active VMCS within a guest, e.g. on nested VM-Enter.
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 * The L1 VMM can protect itself with retpolines, IBPB or IBRS.
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">if</span> (!buddy || <span style="color:#008b45">WARN_ON_ONCE</span>(buddy-&gt;vmcs != prev))
</span></span><span style="display:flex;"><span>			<span style="color:#008b45">indirect_branch_prediction_barrier</span>();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (!already_loaded) {
</span></span><span style="display:flex;"><span>		<span style="color:#00688b;font-weight:bold">void</span> *gdt = <span style="color:#008b45">get_current_gdt_ro</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 * Flush all EPTP/VPID contexts, the new pCPU may have stale
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 * TLB entries from its previous association with the vCPU.
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">kvm_make_request</span>(KVM_REQ_TLB_FLUSH, vcpu);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#228b22">/*
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 * Linux uses per-cpu TSS and GDT, so set these when switching
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 * processors.  See 22.2.4.
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">		 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">vmcs_writel</span>(HOST_TR_BASE,
</span></span><span style="display:flex;"><span>			    (<span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">long</span>)&amp;<span style="color:#008b45">get_cpu_entry_area</span>(cpu)-&gt;tss.x86_tss);
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">vmcs_writel</span>(HOST_GDTR_BASE, (<span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">long</span>)gdt);   <span style="color:#228b22">/* 22.2.4 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">if</span> (<span style="color:#008b45">IS_ENABLED</span>(CONFIG_IA32_EMULATION) || <span style="color:#008b45">IS_ENABLED</span>(CONFIG_X86_32)) {
</span></span><span style="display:flex;"><span>			<span style="color:#228b22">/* 22.2.3 */</span>
</span></span><span style="display:flex;"><span>			<span style="color:#008b45">vmcs_writel</span>(HOST_IA32_SYSENTER_ESP,
</span></span><span style="display:flex;"><span>				    (<span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">long</span>)(<span style="color:#008b45">cpu_entry_stack</span>(cpu) + <span style="color:#b452cd">1</span>));
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		vmx-&gt;loaded_vmcs-&gt;cpu = cpu;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>åˆ¤æ–­<code>vmx-&gt;loaded_vmcs-&gt;cpu</code>ä¸ç»™å®šçš„é€»è¾‘<code>cpu</code>æ˜¯å¦ç›¸ç­‰ï¼Œè‹¥ä¸ç›¸ç­‰:</p>
<ol>
<li>
<p><code>loaded_vmcs_clear</code>åˆ°<code>loaded_vmcs-&gt;cpu</code>æŒ‡å®šçš„é€»è¾‘<code>cpu</code>æ‰§è¡Œ<code>vmclear</code>æŒ‡ä»¤ã€‚</p>
</li>
<li>
<p>å–å‡ºå½“å‰é€»è¾‘<code>cpu</code>çš„<code>per_cpu</code>å˜é‡<code>current_vmcs</code>ä¸<code>vmx-&gt;loaded_vmcs-&gt;vmcs</code>åšæ¯”è¾ƒï¼Œè‹¥ç›¸ç­‰åˆ™è°ƒç”¨<code>vmcs_load</code>ä»¥<code>vmx-&gt;loaded_vmcs-&gt;vmcs</code>ä¸ºæ“ä½œæ•°æ‰§è¡Œ<code>vmptrld</code>æŒ‡ä»¤ã€‚</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">inline</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">vmcs_load</span>(<span style="color:#8b008b;font-weight:bold">struct</span> vmcs *vmcs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	u64 phys_addr = <span style="color:#008b45">__pa</span>(vmcs);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (<span style="color:#008b45">static_branch_unlikely</span>(&amp;enable_evmcs))
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#008b45">evmcs_load</span>(phys_addr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">vmx_asm1</span>(vmptrld, <span style="color:#cd5555">&#34;m&#34;</span>(phys_addr), vmcs, phys_addr);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>è®¾ç½®<code>vmx-&gt;loaded_vmcs-&gt;cpu</code>ä¸ºå½“å‰é€»è¾‘<code>cpu</code>ï¼Œç»“æŸ<code>vmx_vcpu_load_vmcs</code>å¹¶è¿”å›ä¸Šä¸€çº§è°ƒç”¨ã€‚</p>
</li>
</ol>
</li>
</ul>
<h3 id="vcpu_put"><code>vcpu_put</code></h3>
<p><code>vcpu_put</code>å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">vcpu_put</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vcpu *vcpu)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">preempt_disable</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">kvm_arch_vcpu_put</span>(vcpu);
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">preempt_notifier_unregister</span>(&amp;vcpu-&gt;preempt_notifier);
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">__this_cpu_write</span>(kvm_running_vcpu, <span style="color:#658b00">NULL</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">preempt_enable</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡<code>kvm_arch_vcpu_put</code>æœ€ç»ˆè°ƒç”¨åˆ°<code>vmx_vcpu_put</code>:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">vmx_vcpu_put</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vcpu *vcpu)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">vmx_vcpu_pi_put</span>(vcpu);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">vmx_prepare_switch_to_host</span>(<span style="color:#008b45">to_vmx</span>(vcpu));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°<code>vcpu_put</code>å…¶å®å°±æ˜¯<code>vcpu_load</code>çš„é€†è¿‡ç¨‹ã€‚</p>
<h3 id="kvm_sched_in"><code>kvm_sched_in</code></h3>
<p>æ ¹æ®ä¹‹å‰<code>vCPU</code>åˆ›å»ºæµç¨‹ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨<code>ioctl(KVM_RUN)</code>ï¼Œå®¿ä¸»æœºè°ƒåº¦å™¨åœ¨è°ƒåº¦<code>vCPU</code>æ—¶ä½¿ç”¨<code>vcpu_load</code>ï¼›å¦‚æœ<code>ioctl(KVM_RUN)</code>ä¸æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œåˆ™é€šè¿‡<code>kvm_sched_in</code>è°ƒç”¨<code>kvm_arch_vcpu_load</code>æœ€ç»ˆè°ƒç”¨åˆ°<code>vmx_vcpu_load</code>:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">kvm_sched_in</span>(<span style="color:#8b008b;font-weight:bold">struct</span> preempt_notifier *pn, <span style="color:#00688b;font-weight:bold">int</span> cpu)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vcpu *vcpu = <span style="color:#008b45">preempt_notifier_to_vcpu</span>(pn);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">WRITE_ONCE</span>(vcpu-&gt;preempted, <span style="color:#658b00">false</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">WRITE_ONCE</span>(vcpu-&gt;ready, <span style="color:#658b00">false</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">__this_cpu_write</span>(kvm_running_vcpu, vcpu);
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">kvm_arch_sched_in</span>(vcpu, cpu);
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">kvm_arch_vcpu_load</span>(vcpu, cpu);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å½“é€»è¾‘<code>cpu</code>æ‰§è¡Œè™šæ‹Ÿæœºä»£ç æ—¶ï¼Œå½“å‰<code>vCPU</code>çº¿ç¨‹æ˜¯ç¦æ­¢æŠ¢å ä»¥åŠè¢«ä¸­æ–­æ‰“æ–­çš„ï¼Œä½†æ˜¯ä¸­æ–­å¯ä»¥è§¦å‘<code>VM-Exit</code>ï¼Œæ­¤æ—¶é€»è¾‘<code>cpu</code>å¯ä»¥è°ƒåº¦å…¶ä»–çº¿ç¨‹ã€‚å½“å†æ¬¡<code>VM-Entry</code>æ—¶ï¼Œå®¿ä¸»æœºè°ƒåº¦å™¨å°†<code>vCPU</code>çº¿ç¨‹è°ƒåº¦åˆ°å…¶ä»–é€»è¾‘<code>cpu</code>ï¼Œæ­¤æ—¶éœ€è¦<code>kvm_sched_in</code>æ¥å®Œæˆè¿™ä¸ªåŠ¨ä½œã€‚</p>
<h3 id="kvm_sched_out"><code>kvm_sched_out</code></h3>
<p><code>kvm_sched_out</code>æ˜¯<code>kvm_sched_in</code>çš„é€†è¿‡ç¨‹ã€‚å½“<code>vCPU</code>å‘ç”Ÿ<code>VM-Exit</code>æ—¶ï¼Œå®¿ä¸»æœºè°ƒç”¨<code>kvm_sched_out</code>å‡½æ•°æ¥è§¦å½“å‰é€»è¾‘<code>cpu</code>ä¸<code>vCPU</code>çš„å…³è”:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">kvm_sched_out</span>(<span style="color:#8b008b;font-weight:bold">struct</span> preempt_notifier *pn,
</span></span><span style="display:flex;"><span>			  <span style="color:#8b008b;font-weight:bold">struct</span> task_struct *next)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> kvm_vcpu *vcpu = <span style="color:#008b45">preempt_notifier_to_vcpu</span>(pn);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (current-&gt;on_rq) {
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">WRITE_ONCE</span>(vcpu-&gt;preempted, <span style="color:#658b00">true</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">WRITE_ONCE</span>(vcpu-&gt;ready, <span style="color:#658b00">true</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">kvm_arch_vcpu_put</span>(vcpu);
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">__this_cpu_write</span>(kvm_running_vcpu, <span style="color:#658b00">NULL</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>kvm_arch_vcpu_put</code>æœ€ç»ˆè°ƒç”¨<code>vmx_vcpu_put</code>ã€‚ç”±äº<code>vmx_vcpu_put</code>å·²ç»åœ¨<a class="link" href="#vcpu_put" ><code>vcpu_put</code></a>åˆ†æè¿‡ï¼Œæ­¤å¤„ä¸å†è¯¦ç»†è¯´æ˜ã€‚</p>
<h2 id="simple-kvmtool"><code>simple-kvmtool</code></h2>
<p><code>simple-kvmtool</code>æ˜¯ä¸€ä¸ªç®€å•çš„ç±»ä¼¼äº<code>kvmtool</code>çš„ç”¨æˆ·æ€å·¥å…·ï¼Œå‚è€ƒè‡ªhttps://lwn.net/Articles/658512/ã€‚</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&lt;asm/kvm.h&gt;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&lt;err.h&gt;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&lt;fcntl.h&gt;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&lt;linux/kvm.h&gt;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&lt;stddef.h&gt;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&lt;stdint.h&gt;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&lt;stdio.h&gt;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&lt;stdlib.h&gt;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&lt;string.h&gt;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&lt;sys/ioctl.h&gt;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&lt;sys/mman.h&gt;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&lt;sys/stat.h&gt;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&lt;sys/types.h&gt;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>
</span></span><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">int</span> <span style="color:#008b45">main</span>(<span style="color:#00688b;font-weight:bold">void</span>) {
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">int</span> kvmfd, vmfd, vcpufd, ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint8_t</span> guest_code[] = {
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xba</span>, <span style="color:#b452cd">0xf8</span>, <span style="color:#b452cd">0x03</span>, <span style="color:#228b22">/* mov $0x3f8, %dx */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xb0</span>, <span style="color:#cd5555">&#39;H&#39;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xee</span>,			  <span style="color:#228b22">/* mov $&#39;H&#39; , %al*/</span>
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xb0</span>, <span style="color:#cd5555">&#39;e&#39;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xee</span>,			 <span style="color:#228b22">/* out %al, (%dx) */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xb0</span>, <span style="color:#cd5555">&#39;l&#39;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xee</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xb0</span>, <span style="color:#cd5555">&#39;l&#39;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xee</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xb0</span>, <span style="color:#cd5555">&#39;o&#39;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xee</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xb0</span>, <span style="color:#cd5555">&#39;,&#39;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xee</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xb0</span>, <span style="color:#cd5555">&#39;H&#39;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xee</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xb0</span>, <span style="color:#cd5555">&#39;o&#39;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xee</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xb0</span>, <span style="color:#cd5555">&#39;s&#39;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xee</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xb0</span>, <span style="color:#cd5555">&#39;t&#39;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xee</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xb0</span>, <span style="color:#cd5555">&#39;\n&#39;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xee</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#b452cd">0xf4</span>,			<span style="color:#228b22">/* hlt */</span>
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">uint8_t</span> *mem;
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> kvm_sregs sregs;
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">size_t</span> mmap_size;
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> kvm_run *run;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	kvmfd = <span style="color:#008b45">open</span>(<span style="color:#cd5555">&#34;/dev/kvm&#34;</span>, O_RDWR | O_CLOEXEC);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (kvmfd == -<span style="color:#b452cd">1</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">err</span>(<span style="color:#b452cd">1</span>, <span style="color:#cd5555">&#34;/dev/kvm&#34;</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/* Make sure we have the stable version of the API */</span>
</span></span><span style="display:flex;"><span>	ret = <span style="color:#008b45">ioctl</span>(kvmfd, KVM_GET_API_VERSION, <span style="color:#b452cd">0</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (ret == -<span style="color:#b452cd">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">err</span>(<span style="color:#b452cd">1</span>, <span style="color:#cd5555">&#34;KVM_GET_API_VERSION&#34;</span>);	
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (ret != <span style="color:#b452cd">12</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#008b45">errx</span>(<span style="color:#b452cd">1</span>, <span style="color:#cd5555">&#34;KVM_GET_API_VERSION %d, expected 12&#34;</span>, ret);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	vmfd = <span style="color:#008b45">ioctl</span>(kvmfd, KVM_CREATE_VM, (<span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">long</span>)<span style="color:#b452cd">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">if</span> (vmfd == -<span style="color:#b452cd">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#008b45">err</span>(<span style="color:#b452cd">1</span>, <span style="color:#cd5555">&#34;KVM_CREATE_VM&#34;</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/* Allocate one aligned page of guest memory to hold the code. */</span>
</span></span><span style="display:flex;"><span>	mem = <span style="color:#008b45">mmap</span>(<span style="color:#658b00">NULL</span>, <span style="color:#b452cd">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, -<span style="color:#b452cd">1</span>, <span style="color:#b452cd">0</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (!mem) {
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">err</span>(<span style="color:#b452cd">1</span>, <span style="color:#cd5555">&#34;allocating guest memory&#34;</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">memcpy</span>(mem, guest_code, <span style="color:#8b008b;font-weight:bold">sizeof</span>(guest_code));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/* Map it to the second page frame (to avoid the real-mode IDT at 0). */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> kvm_userspace_memory_region guest_region = {
</span></span><span style="display:flex;"><span>		.slot = <span style="color:#b452cd">0</span>,
</span></span><span style="display:flex;"><span>		.guest_phys_addr = <span style="color:#b452cd">0x1000</span>,
</span></span><span style="display:flex;"><span>		.memory_size = <span style="color:#b452cd">0x1000</span>,
</span></span><span style="display:flex;"><span>		.userspace_addr = (<span style="color:#00688b;font-weight:bold">uint64_t</span>)mem,
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ret = <span style="color:#008b45">ioctl</span>(vmfd, KVM_SET_USER_MEMORY_REGION, &amp;guest_region);
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (ret == -<span style="color:#b452cd">1</span>) 
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">err</span>(<span style="color:#b452cd">1</span>, <span style="color:#cd5555">&#34;KVM_SET_USER_MEMORY_REGION&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	vcpufd = <span style="color:#008b45">ioctl</span>(vmfd, KVM_CREATE_VCPU);
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (vcpufd == -<span style="color:#b452cd">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#008b45">err</span>(<span style="color:#b452cd">1</span>, <span style="color:#cd5555">&#34;KVM_CREATE_VCPU&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#228b22">/* Map the shared kvm_run structure and following data. */</span>
</span></span><span style="display:flex;"><span>	ret = <span style="color:#008b45">ioctl</span>(kvmfd, KVM_GET_VCPU_MMAP_SIZE, <span style="color:#658b00">NULL</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (ret == -<span style="color:#b452cd">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">err</span>(<span style="color:#b452cd">1</span>, <span style="color:#cd5555">&#34;KVM_GET_MMAP_SIZE&#34;</span>);
</span></span><span style="display:flex;"><span>	mmap_size = ret;
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (mmap_size &lt; <span style="color:#8b008b;font-weight:bold">sizeof</span>(*run))
</span></span><span style="display:flex;"><span>        <span style="color:#008b45">errx</span>(<span style="color:#b452cd">1</span>, <span style="color:#cd5555">&#34;KVM_GET_VCPU_MMAP_SIZE unexpectedly small&#34;</span>);
</span></span><span style="display:flex;"><span>	run = <span style="color:#008b45">mmap</span>(<span style="color:#658b00">NULL</span>, mmap_size, PROT_READ | PROT_WRITE, MAP_SHARED, vcpufd, <span style="color:#b452cd">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">if</span> (!run)
</span></span><span style="display:flex;"><span>        <span style="color:#008b45">err</span>(<span style="color:#b452cd">1</span>, <span style="color:#cd5555">&#34;mmap vcpu&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/* Initialize CS to point at 0, via a read-modify-write of sregs. */</span>
</span></span><span style="display:flex;"><span>	ret = <span style="color:#008b45">ioctl</span>(vcpufd, KVM_GET_SREGS, &amp;sregs);
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (ret == -<span style="color:#b452cd">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#008b45">err</span>(<span style="color:#b452cd">1</span>, <span style="color:#cd5555">&#34;KVM_GET_SREGS&#34;</span>);
</span></span><span style="display:flex;"><span>	sregs.cs.base = <span style="color:#b452cd">0</span>;
</span></span><span style="display:flex;"><span>    sregs.cs.selector = <span style="color:#b452cd">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ret = <span style="color:#008b45">ioctl</span>(vcpufd, KVM_SET_SREGS, &amp;sregs);
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">if</span> (ret == -<span style="color:#b452cd">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#008b45">err</span>(<span style="color:#b452cd">1</span>, <span style="color:#cd5555">&#34;KVM_SET_SREGS&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#228b22">/* Initialize registers: instruction pointer for our code, addends, and
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * initial flags required by x86 architecture. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">struct</span> kvm_regs regs = {
</span></span><span style="display:flex;"><span>        .rip = <span style="color:#b452cd">0x1000</span>,
</span></span><span style="display:flex;"><span>        .rax = <span style="color:#b452cd">2</span>,
</span></span><span style="display:flex;"><span>        .rbx = <span style="color:#b452cd">2</span>,
</span></span><span style="display:flex;"><span>        .rflags = <span style="color:#b452cd">0x2</span>,
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>	ret = <span style="color:#008b45">ioctl</span>(vcpufd, KVM_SET_REGS, &amp;regs);
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (ret == -<span style="color:#b452cd">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">err</span>(<span style="color:#b452cd">1</span>, <span style="color:#cd5555">&#34;KVM_SET_REGS&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/* Repeatedly run code and handle VM exits. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">while</span> (<span style="color:#b452cd">1</span>) {
</span></span><span style="display:flex;"><span>		ret = <span style="color:#008b45">ioctl</span>(vcpufd, KVM_RUN, <span style="color:#658b00">NULL</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">switch</span> (run-&gt;exit_reason) {
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">case</span> KVM_EXIT_HLT:
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">0</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">case</span> KVM_EXIT_IO:
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">if</span> (run-&gt;io.direction == KVM_EXIT_IO_OUT &amp;&amp; run-&gt;io.size == <span style="color:#b452cd">1</span> 
</span></span><span style="display:flex;"><span>				&amp;&amp; run-&gt;io.port == <span style="color:#b452cd">0x3f8</span> &amp;&amp; run-&gt;io.count == <span style="color:#b452cd">1</span>) {
</span></span><span style="display:flex;"><span>					<span style="color:#008b45">putchar</span>(*(((<span style="color:#00688b;font-weight:bold">char</span>*)run) + run-&gt;io.data_offset));
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰§è¡Œçš„æ•ˆæœå¦‚ä¸‹æ‰€ç¤º:</p>
<p><img src="/post/kernel/virtualization/cpu%E8%99%9A%E6%8B%9F%E5%8C%96/sample-kvmtool.png"
	width="664"
	height="148"
	srcset="/post/kernel/virtualization/cpu%E8%99%9A%E6%8B%9F%E5%8C%96/sample-kvmtool_huc14442ee6a63fe24cd48640be37397f3_18015_480x0_resize_box_3.png 480w, /post/kernel/virtualization/cpu%E8%99%9A%E6%8B%9F%E5%8C%96/sample-kvmtool_huc14442ee6a63fe24cd48640be37397f3_18015_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="sample-kvmtool"
	
	
		class="gallery-image" 
		data-flex-grow="448"
		data-flex-basis="1076px"
	
></p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<blockquote>
<ol>
<li>æ·±å…¥æµ…å‡ºç³»ç»Ÿè™šæ‹ŸåŒ–åŸç†ä¸å®è·µ</li>
<li><code>qemu/kvm</code>æºç è§£æä¸åº”ç”¨</li>
<li>ç³»ç»Ÿè™šæ‹ŸåŒ–åŸç†ä¸å®ç°</li>
<li>æ·±åº¦æ¢ç´¢<code>Linux</code>ç³»ç»Ÿè™šåŒ–åŸç†ä¸å®ç°</li>
<li><a class="link" href="https://notes.caijiqhx.top/ucas/virtualization/vmcs/"  target="_blank" rel="noopener"
    >https://notes.caijiqhx.top/ucas/virtualization/vmcs/</a></li>
<li><a class="link" href="https://oenhan.com/kvm-src-3-cpu"  target="_blank" rel="noopener"
    >https://oenhan.com/kvm-src-3-cpu</a></li>
<li><a class="link" href="http://liujunming.top/2021/07/22/Introduction-to-Intel-VMCS-Shadowing-technology/"  target="_blank" rel="noopener"
    >http://liujunming.top/2021/07/22/Introduction-to-Intel-VMCS-Shadowing-technology/</a> (è™šæ‹ŸåŒ–åšå®¢)</li>
<li><a class="link" href="https://eqqie.cn/index.php/archives/1972"  target="_blank" rel="noopener"
    >https://eqqie.cn/index.php/archives/1972</a> (åŸºäº<code>Intel VMX</code>çš„ç®€æ˜“è™šæ‹Ÿæœº)</li>
<li><a class="link" href="https://www.freesion.com/article/9429791169/"  target="_blank" rel="noopener"
    >https://www.freesion.com/article/9429791169/</a></li>
<li><code>IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual Combined Volumes 1, 2A, 2B, 2C, 2D, 3A, 3B, 3C, 3D, and 4.pdf</code></li>
</ol>
</blockquote>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/kernel/">kernel</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css"integrity="sha256-J&#43;iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s="crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js"integrity="sha256-InsNdER1b2xUewP&#43;pKCUJpkhiqwHgqiPXDlIk7GzBu4="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js"integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "stack" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2023 All Rights Reserved
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.20.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
